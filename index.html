<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆcompact +/âˆ’ãƒ»ï¼…è¡¨ç¤ºãƒ»ä¸‡å††ï¼‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --navy:#0e2a47; --teal:#10939a; --teal-2:#0c7e86;
      --yellow:#ffbf3a; --yellow-2:#ffe28f; --bg:#f7fafc; --card:#ffffff;
      --muted:#5f6f84; --ring:rgba(16,147,154,.25); --line:#e6edf5;
      --coral:#ff4d6d; --coral-2:#ff6b81;
    }
    *{box-sizing:border-box}
    body{
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",sans-serif;
      padding:20px; background:var(--bg); max-width:1100px; margin:auto; font-size:18px; color:#102a43;
      background-image:radial-gradient(ellipse at 10% -20%, rgba(255,216,97,.18), transparent 45%),
                       radial-gradient(ellipse at 110% 10%, rgba(25,183,181,.08), transparent 40%);
    }
    .title-wrap{ text-align:center; margin:6px 0 10px;}
    .subtitle{ display:inline-block; margin-bottom:8px; font-weight:800; color:#0d3a57; letter-spacing:.08em;}
    .subtitle::before{ content:"ï¼¼ "; } .subtitle::after{ content:" ï¼"; }
    .title{ margin:0; color:var(--navy); font-weight:900; letter-spacing:.02em; font-size:clamp(22px,4.5vw,32px);}

    .card{ background:var(--card); border-radius:16px; padding:18px; margin-top:16px; box-shadow:0 8px 24px rgba(15,48,87,.08); border:1px solid #eef3f9;}
    .panel-title{ display:flex; align-items:center; gap:.5rem; margin:-6px 0 14px; font-weight:900; color:var(--navy);
      background:linear-gradient(90deg,var(--yellow),var(--yellow-2)); padding:.45rem .9rem; border-radius:999px; border:1px solid rgba(0,0,0,.06);
      box-shadow:0 4px 0 rgba(15,48,87,.08); font-size:18px; width:fit-content; white-space:nowrap;}
    .panel-title .chip{ display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:999px;
      background:linear-gradient(135deg,var(--teal),var(--teal-2)); color:#fff; font-weight:900; font-size:.9rem;}

    .section-title{ font-weight:900; font-size:16px; color:var(--navy); margin:18px 0 8px; padding:.35rem .7rem;
      background:repeating-linear-gradient(-45deg, rgba(255,216,97,.35) 0 6px, rgba(255,216,97,.22) 6px 12px);
      border-radius:8px; display:block; width:fit-content; white-space:nowrap; }

    .range-labels{ display:flex; justify-content:space-between; font-size:.9rem; color:var(--muted); margin:4px 0 8px;}
    .inline-group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px;}
    input[type="number"],input[type="text"],input[type="range"],select{
      padding:.7rem .8rem; font-size:1rem; width:100%; border-radius:12px; border:1px solid #dfe8f2; background:#fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input[type="number"]:focus,input[type="text"]:focus,select:focus{ outline:none; border-color:var(--teal-2); box-shadow:0 0 0 4px var(--ring);}
    input[type="range"]{ accent-color:var(--teal-2); }

    .actions{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:12px;}
    .btn{ appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.02em;
      padding:1rem; border-radius:12px; transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
      font-size: calc(1rem + 2pt); }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ color:#fff; background:linear-gradient(135deg,var(--coral),var(--coral-2));
      border:1px solid rgba(0,0,0,.12); box-shadow:0 10px 22px rgba(255,77,109,.35); }
    .btn-ghost{ background:linear-gradient(135deg,#bfe8ea,#8fdde0); color:#083b40; border:1px solid #6fd0d3; box-shadow:0 4px 10px rgba(13,126,134,.18);}

    .kpi{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:12px;}
    .kpi .tile{ background:#fff; border:1px dashed #d9e6f3; border-radius:12px; padding:14px;}
    .kpi .label{ font-size:.9rem; color:#3a5066;} .kpi .value{ font-weight:900; font-size:1.3rem; margin-top:4px; color:var(--navy);}
    #result{ white-space: pre-line; font-size:1rem; background:#fffef5; border:1px dashed #ffe28d; border-radius:10px; padding:10px;}

    table{ width:100%; border-collapse:collapse; margin-top:18px; font-size:.95rem;}
    th,td{ border:1px solid var(--line); padding:.6rem; text-align:right;}
    th{ background:#f2fbfc; color:#0b4a4f; font-weight:800;}

    .chart-block{ margin-top:14px; }
    .chart-title{ font-size:16px; font-weight:800; color:var(--navy); margin:6px 4px; }
    .chart-wrap{ width:100%; height:300px; background:linear-gradient(#fff,#fff) padding-box,
        repeating-linear-gradient(0deg, #f2f7fb 0 28px, #e9f1f8 28px 29px) border-box;
      border:1px solid #dfe8f2; border-radius:12px; padding:10px; overflow:hidden;}
    .chart-wrap>canvas{ display:block; width:100% !important; height:100% !important;}
    @media (max-width:640px){ .chart-wrap{ height:170px; } }

    .note{ font-size:.9rem; color:#3a5066; margin-top:4px}
    .row-end{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px;}
    .hint{ font-size:.9rem; color:#3a5066;}
    .rate-input-row{ display:flex; align-items:center; gap:10px; margin-top:8px;}
    .rate-input-row span{ width:20%; font-size:.95rem; color:var(--muted);} .rate-input-row input{ width:35%; }

    /* ===== é‡‘åˆ©ä¸€æ‹¬å…¥åŠ›ï¼ˆâˆ’ æ•°å€¤ % ï¼‹ / ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ / é©ç”¨ï¼‰ ===== */
    .rate-toolbar{
      display:grid; grid-template-columns: auto auto 1fr; gap:10px; align-items:center; margin-top:8px; width:100%;
    }
    @media (max-width:640px){ .rate-toolbar{ grid-template-columns: 1fr 1fr; } .rate-toolbar .btn-compact{ grid-column:1/-1; } }

    @media (min-width: 768px) {
  .rate-field{
    height: 44px;                 /* é«˜ã•ã‚’çµ±ä¸€ */
    display:grid; 
    grid-template-columns: 36px minmax(60px,84px) 18px 36px;
    align-items:center;
    gap:4px; 
    background:#fff; 
    border:1px solid #dfe8f2; 
    border-radius:12px; 
    padding:0 8px;                /* ä¸Šä¸‹paddingã‚’0ã« */
    width:max-content; 
    max-width:100%;
  }
}
    .icon-btn{
      width:36px; height:36px; border:none; background:#e9f7f8; color:#0c7e86; border-radius:10px;
      display:inline-flex; align-items:center; justify-content:center; font-size:20px; font-weight:900;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.05);
    }
    .icon-btn:active{ transform:translateY(1px); }
    .rate-input{
      width:84px; /* 70px â†’ 84px ã«æ‹¡å¤§ */
  text-align:right; border:none; outline:none; font-weight:800; font-size:1rem;
  padding:.4rem .2rem; border-radius:8px; background:transparent;
    }
    .rate-suffix{ font-weight:800; color:#0c7e86; text-align:center; user-select:none; }
    @media (max-width:480px){
      .rate-field{ grid-template-columns: 32px minmax(48px,64px) 16px 32px; padding:4px 6px; }
      .icon-btn{ width:32px; height:32px; font-size:18px; }
      .rate-input{ width:64px; font-size:.95rem; height:32px; }
      .rate-suffix{ font-size:.95rem; }
    }

@media (min-width: 768px) {
  .scope-field select{
    height: 44px;                 /* é«˜ã•ã‚’çµ±ä¸€ */
    padding:0 .7rem;              /* ä¸Šä¸‹paddingã‚’0ã« */
    border-radius:12px; 
    border:1px solid #dfe8f2; 
    background:#fff; 
    font-size:1rem;
    font-weight:700; 
    min-width:9.5em;
    display: flex;
    align-items: center;          /* ç¸¦ä¸­å¤®æƒãˆ */
  }
}
@media (min-width: 768px) {
  .btn-compact{
    height: 44px;                 /* é«˜ã•ã‚’çµ±ä¸€ */
    color:#fff; 
    background:linear-gradient(135deg,#0c7e86,#10939a); 
    border:1px solid rgba(0,0,0,.08);
    box-shadow:0 8px 18px rgba(12,126,134,.28); 
    padding:0 1rem;               /* ä¸Šä¸‹paddingã‚’0ã« */
    font-size:0.95rem;
    border-radius:10px; 
    display:inline-flex; 
    gap:.4rem; 
    align-items:center;           /* ç¸¦ä¸­å¤®æƒãˆ */
    font-weight:900;
  }
}
    .btn-compact:hover{ filter:brightness(1.05); } .btn-compact:active{ transform:translateY(1px); }
  </style>
</head>
<body onload="generateRateInputs()">
  <div class="title-wrap">
    <div class="subtitle">é‡‘åˆ©ã®å¤‰å‹•ã«å¯¾å¿œ</div>
    <h1 class="title">ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  </div>

  <!-- æ¡ä»¶ -->
  <div class="card">
    <div class="panel-title"><span class="chip">1</span>æ¡ä»¶</div>

    <div class="section-title">å€Ÿå…¥é¡ï¼ˆä¸‡å††ï¼‰</div>
    <input type="text" id="amount" value="3500" oninput="syncAmountFromText()" />
    <div class="range-labels"><span>1,000ä¸‡å††</span><span>2å„„å††</span></div>
    <input type="range" id="amount-range" min="1000" max="10000" step="10" value="3500" oninput="syncAmountFromRange()" />

    <div class="section-title">è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</div>
    <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
    <div class="range-labels"><span>1å¹´</span><span>50å¹´</span></div>
    <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

    <div class="section-title">è¿”æ¸ˆæ–¹å¼</div>
    <div class="inline-group">
      <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</label>
      <label><input type="radio" name="repaymentType" value="principalEqual" /> å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</label>
    </div>

    <div class="section-title">é‡‘åˆ©ï¼ˆï¼…ï¼‰</div>

    <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆé‡‘åˆ©ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="rate-toolbar">
      <div class="rate-field">
        <button type="button" class="icon-btn" aria-label="é‡‘åˆ©ã‚’0.05ä¸‹ã’ã‚‹" onclick="adjustRate(-0.05)">âˆ’</button>
        <!-- ä¸€æ‹¬å…¥åŠ›ã¯ bulk-rate-input ã¨ã—ã¦åŒºåˆ¥ -->
        <input type="number" id="bulkRateUnified" class="rate-input bulk-rate-input" step="0.01" value="1.00" />
        <span class="rate-suffix">%</span>
        <button type="button" class="icon-btn" aria-label="é‡‘åˆ©ã‚’0.05ä¸Šã’ã‚‹" onclick="adjustRate(0.05)">ï¼‹</button>
      </div>
      <div class="scope-field"><select id="applyScope"></select></div>
      <button type="button" class="btn-compact" onclick="applyRateUnified()">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M21 7L9 19l-6-6 1.5-1.5L9 16l10.5-10.5L21 7z"/></svg> é©ç”¨
      </button>
    </div>

    <!-- åŠå¹´ã”ã¨ã®æ‰‹å…¥åŠ›æ¬„ -->
    <div id="rate-inputs"></div>

    <div class="section-title">ğŸ“ˆ ãƒ‰ãƒ©ãƒƒã‚°ã§é‡‘åˆ©ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
    <p class="note">ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ã€Œãã®ç‚¹ä»¥é™ã¯åŒã˜é‡‘åˆ©ã€ã€Œãã‚Œä»¥å‰ã¯ç›´å‰2ãƒã‚¤ãƒ³ãƒˆï¼ˆ=1å¹´ï¼‰ã ã‘ãªã ã‚‰ã‹ã«è¿‘ã¥ãã€</p>
    <div class="chart-wrap"><canvas id="rateChart"></canvas></div>

    <div class="actions">
      <button class="btn btn-primary" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</button>
    </div>
  </div>

  <!-- çµæœ -->
  <div class="card">
    <div class="panel-title"><span class="chip">2</span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
    <div id="result"></div>
    <div class="kpi" id="kpiTiles" style="display:none;">
      <div class="tile"><div class="label">åˆæœˆã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-first"></div></div>
      <div class="tile"><div class="label">å¹³å‡ã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-avg"></div></div>
      <div class="tile"><div class="label">æœ€å¤§ã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-max"></div></div>
    </div>

    <div class="chart-block">
      <div class="chart-title">æœˆã€…ã®æ”¯æ‰•é¡</div>
      <div class="chart-wrap"><canvas id="paymentChart"></canvas></div>
    </div>
    <div class="chart-block">
      <div class="chart-title">æ”¯æ‰•å†…è¨³ï¼ˆå…ƒé‡‘/åˆ©æ¯ï¼‰</div>
      <div class="chart-wrap"><canvas id="stackedChart"></canvas></div>
    </div>

    <div class="row-end">
      <label class="hint"><input type="checkbox" id="toggle-table" checked> æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º</label>
      <span class="hint">â€»ã‚ªãƒ•ã«ã™ã‚‹ã¨è»½ããªã‚Šã¾ã™</span>
    </div>
    <div id="repayment-table"></div>

    <div class="actions">
      <button class="btn btn-ghost" onclick="downloadExcel()">ğŸ“¥ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’Excelã§ä¿å­˜</button>
    </div>
  </div>

  <script>
    let lastSimData=[], rateChartInstance=null, paymentChart=null, stackedChart=null;

    function syncAmountFromRange(){ const v=+document.getElementById('amount-range').value; document.getElementById('amount').value=v.toLocaleString(); }
    function syncAmountFromText(){ const raw=document.getElementById('amount').value.replace(/[^\d]/g,''); const n=parseInt(raw||'0'); document.getElementById('amount-range').value=n; document.getElementById('amount').value=n.toLocaleString(); }
    function syncYearsFromRange(){ const v=+document.getElementById('years-range').value; document.getElementById('years').value=v; generateRateInputs(); }
    function syncYearsFromInput(){ const v=+document.getElementById('years').value; document.getElementById('years-range').value=v; generateRateInputs(); }
    function parseAmount(v){ return parseFloat(v.replace(/,/g,''))*10000; }

    function generateRateInputs(){
      const container=document.getElementById('rate-inputs'); container.innerHTML='';
      const years=+document.getElementById('years').value;
      const scope=document.getElementById('applyScope'); scope.innerHTML='';
      // ã€Œå…¨æœŸé–“ã€
      const optAll=document.createElement('option'); optAll.value='all'; optAll.textContent='å…¨æœŸé–“'; scope.appendChild(optAll);
      for(let y=1;y<=years;y++){ const o=document.createElement('option'); o.value=String(y); o.textContent=`${y}å¹´ç›®ä»¥é™`; scope.appendChild(o); }

      for(let y=1;y<=years;y++){
        const row=document.createElement('div'); row.className='rate-input-row';
        const label=document.createElement('span'); label.textContent=`${y}å¹´ç›®`;
        const input1=document.createElement('input'); const input2=document.createElement('input');
        [input1,input2].forEach((inp,i)=>{
          inp.type='number'; inp.step='0.01'; inp.value='1.00';
          // åŠå¹´å…¥åŠ›ã¯å°‚ç”¨ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ï¼ˆè¦‹ãŸç›®ç¶­æŒã®ãŸã‚ rate-input ã‚‚ä½µè¨˜ï¼‰
          inp.className='rate-input half-rate-input';
          inp.dataset.index=(y-1)*2+i;
          inp.addEventListener('input',updateRateChartFromInputs);
        });
        row.appendChild(label); row.appendChild(input1); row.appendChild(input2); container.appendChild(row);
      }
      drawRateChart();
    }

    // å…¥åŠ›æ¬„ â†’ ã‚°ãƒ©ãƒ•
    function updateRateChartFromInputs(){
      const inputs=[...document.querySelectorAll('.half-rate-input')];
      const rates=inputs.map(el=>parseFloat(el.value)||0);
      if(rateChartInstance){
        rateChartInstance.data.labels=rates.map((_,i)=>`${Math.floor(i/2)+1}å¹´ç›®`);
        rateChartInstance.data.datasets[0].data=rates;
        rateChartInstance.update();
      }
    }

    // ã‚°ãƒ©ãƒ• â†’ å…¥åŠ›æ¬„
    function updateInputsFromRateChart(rates){
      const inputs=document.querySelectorAll('.half-rate-input');
      rates.forEach((r,i)=>{ if(inputs[i]) inputs[i].value=Number(r).toFixed(2); });
      simulate();
    }

    function clamp06(v){ return Math.max(0, Math.min(6, v)); }
    function adjustRate(delta){
      const el=document.getElementById('bulkRateUnified');
      let v=parseFloat(el.value||'0'); v = clamp06( Math.round((v+delta)*100)/100 ); el.value=v.toFixed(2);
    }

    // ä¸€æ‹¬é©ç”¨ï¼ˆå¯¾è±¡ã¯ .half-rate-input ã®ã¿ï¼‰
    function applyRateUnified(){
      const rate=parseFloat(document.getElementById('bulkRateUnified').value);
      if(isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      const scopeVal=document.getElementById('applyScope').value;
      const inputs=[...document.querySelectorAll('.half-rate-input')];
      if(scopeVal==='all'){ inputs.forEach(inp=>inp.value=rate.toFixed(2)); }
      else{
        const fromYear=parseInt(scopeVal,10);
        const start=(fromYear-1)*2;
        for(let i=start;i<inputs.length;i++) inputs[i].value=rate.toFixed(2);
      }
      updateRateChartFromInputs();
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ç·¨é›†ï¼šY 0ã€œ6%ã€ç›®ç››0.5%
    function drawRateChart(){
      const inputs=[...document.querySelectorAll('.half-rate-input')];
      const rates=inputs.map(el=>parseFloat(el.value)||0);
      const ctx=document.getElementById('rateChart').getContext('2d');
      if(rateChartInstance) rateChartInstance.destroy();

      rateChartInstance=new Chart(ctx,{
        type:'line',
        data:{ labels:rates.map((_,i)=>`${Math.floor(i/2)+1}å¹´ç›®`),
          datasets:[{ label:'åŠå¹´ã”ã¨ã®é‡‘åˆ©ï¼ˆï¼…ï¼‰', data:rates, borderColor:'#0c7e86', backgroundColor:'rgba(12,126,134,0.12)',
            pointRadius:9, pointHoverRadius:12, pointHitRadius:26, pointStyle:'rectRounded', borderWidth:3, tension:.2 }]}
        ,options:{
          responsive:true, maintainAspectRatio:false, animation:false,
          scales:{
            x:{ grid:{display:false}, title:{display:true,text:'ä½•å¹´ç›®',color:'#0e2a47',font:{weight:'bold'}},
                ticks:{ autoSkip:false, maxRotation:0, font:{size:13}, callback:(v,i)=> i%2===1 ? (Math.floor(i/2)+1) : '' }},
            y:{ beginAtZero:true, min:0, max:6, grid:{color:'rgba(0,0,0,.08)'},
                ticks:{ stepSize:.5, font:{size:13}, callback:v=>Number(v).toFixed(1)+'%' } }
          },
          plugins:{
            legend:{display:false},
            tooltip:{ backgroundColor:'#0e2a47', titleColor:'#fff', bodyColor:'#fff',
              callbacks:{ title:(items)=>{ const i=items[0].dataIndex; return `${Math.floor(i/2)+1}å¹´ç›®ï¼ˆ${i%2===0?'å‰åŠ':'å¾ŒåŠ'}ï¼‰`;},
                          label:(ctx)=>`é‡‘åˆ©: ${Number(ctx.parsed.y).toFixed(2)}%` } },
            dragData:{
              round:2, showTooltip:true, dragX:false, dragY:true,
              onDrag:(e,di,idx,val)=>{ const snapped=Math.round(val/0.05)*0.05; return Math.max(0,Math.min(6,snapped)); },
              onDragStart:(e)=>{ if(e&&e.native&&e.native.preventDefault) e.native.preventDefault(); document.body.style.touchAction='none'; },
              onDragEnd:(e,di,index,value)=>{
                document.body.style.touchAction='auto';
                const old=rateChartInstance.data.datasets[0].data, newRates=[...old], len=newRates.length, PRE=2;
                for(let i=index;i<len;i++) newRates[i]=value;           // ä»¥é™ã¯åŒã˜
                const start=Math.max(0,index-PRE), span=index-start;     // ç›´å‰2ç‚¹ã¯ãªã ã‚‰ã‹
                if(span>0){ for(let i=start;i<index;i++){ const t=(i-start+1)/span; newRates[i]=old[i]*(1-t)+value*t; } }
                updateInputsFromRateChart(newRates);
                rateChartInstance.data.datasets[0].data=newRates;
                rateChartInstance.update();
              }
            }
          }
        },
        plugins:[Chart.registry.getPlugin('dragdata')]
      });
    }

    function simulate(){
      const amount=parseAmount(document.getElementById('amount').value);
      const years=+document.getElementById('years').value, months=years*12;
      const repaymentType=document.querySelector("input[name='repaymentType']:checked").value;
      const rates=[...document.querySelectorAll('.half-rate-input')].map(el=>parseFloat(el.value)/100);
      if(!amount||!years) return alert('å€Ÿå…¥é¡ã¨è¿”æ¸ˆæœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      if(rates.length<Math.ceil(months/6)) return alert('é‡‘åˆ©ã®å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚');

      let balance=amount; const result=[], payments=[]; let totalP=0,totalI=0;
      for(let m=0;m<months;m++){
        const r=(rates[Math.floor(m/6)]||0)/12, remain=months-m;
        let interest=balance*r, principal, out;
        if(repaymentType==='principalAndInterestEqual'){
          out = r>0 ? balance*r*Math.pow(1+r,remain)/(Math.pow(1+r,remain)-1) : balance/remain;
          interest=balance*r; principal=out-interest;
        }else{ principal=amount/months; interest=balance*r; out=principal+interest; }
        balance-=principal; if(balance<0) balance=0; totalP+=principal; totalI+=interest; payments.push(out);
        result.push({ æœˆ:m+1, å…ƒé‡‘:Math.round(principal), åˆ©æ¯:Math.round(interest), æ®‹é«˜:Math.round(balance), æ”¯æ‰•é¡:Math.round(out) });
      }
      lastSimData=result; displayResult(result,totalP,totalI,payments); drawCharts(result);
    }

    function displayResult(data,totalP,totalI,payments){
      const totalRepay=Math.ceil(totalP+totalI), interestRounded=Math.ceil(totalI);
      const first=Math.round(payments[0]||0), avg=Math.round((payments.reduce((a,b)=>a+b,0)/payments.length)||0), max=Math.round(Math.max(...payments,0));
      document.getElementById('result').innerHTML=`ğŸ ç·è¿”æ¸ˆé¡: ${totalRepay.toLocaleString()} å††\nğŸ“Š ç·åˆ©æ¯: ${interestRounded.toLocaleString()} å††`;
      document.getElementById('kpiTiles').style.display='grid';
      document.getElementById('kpi-first').textContent=`${first.toLocaleString()} å††`;
      document.getElementById('kpi-avg').textContent=`${avg.toLocaleString()} å††`;
      document.getElementById('kpi-max').textContent=`${max.toLocaleString()} å††`;

      const show=document.getElementById('toggle-table').checked, wrap=document.getElementById('repayment-table'); wrap.innerHTML='';
      if(show){
        const table=document.createElement('table'), thead=table.createTHead(), tbody=table.createTBody();
        thead.innerHTML='<tr><th>æœˆ</th><th>å…ƒé‡‘</th><th>åˆ©æ¯</th><th>æ”¯æ‰•é¡</th><th>æ®‹é«˜</th></tr>';
        for(const row of data){ const tr=tbody.insertRow(); for(const k of ['æœˆ','å…ƒé‡‘','åˆ©æ¯','æ”¯æ‰•é¡','æ®‹é«˜']){ const td=tr.insertCell(); td.textContent=row[k].toLocaleString(); } }
        wrap.appendChild(table);
      }
    }

    function drawCharts(data){
      const labels=data.map(d=>d['æœˆ']), principal=data.map(d=>d['å…ƒé‡‘']), interest=data.map(d=>d['åˆ©æ¯']), payment=data.map(d=>d['æ”¯æ‰•é¡']);
      if(paymentChart) paymentChart.destroy(); if(stackedChart) stackedChart.destroy();
      const axisFont={size:13}, common={ responsive:true, maintainAspectRatio:false, animation:false,
        scales:{ x:{ticks:{maxRotation:0,autoSkip:true,autoSkipPadding:16,font:axisFont},grid:{display:false}},
                 y:{ticks:{font:axisFont},grid:{color:'rgba(0,0,0,.08)'},beginAtZero:true,min:0}}, plugins:{legend:{display:false}} };
      paymentChart=new Chart(document.getElementById('paymentChart').getContext('2d'),{
        type:'bar', data:{labels,datasets:[{label:'æœˆã€…ã®æ”¯æ‰•é¡',data:payment,backgroundColor:'#0c7e86'}]}, options:common });
      stackedChart=new Chart(document.getElementById('stackedChart').getContext('2d'),{
        type:'bar', data:{labels,datasets:[{label:'å…ƒé‡‘',data:principal,backgroundColor:'#0c7e86'},{label:'åˆ©æ¯',data:interest,backgroundColor:'#ffbf3a'}]},
        options:{...common, scales:{...common.scales, x:{...common.scales.x,stacked:true}, y:{...common.scales.y,stacked:true}}} });
    }

    function downloadExcel(){
      if(!lastSimData.length) return alert('ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
      const ws=XLSX.utils.json_to_sheet(lastSimData), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'); XLSX.writeFile(wb,'loan_simulation.xlsx');
    }

    document.addEventListener('change',e=>{
      if(e.target && e.target.id==='toggle-table' && lastSimData.length){
        let tp=0,ti=0; for(const r of lastSimData){ tp+=r['å…ƒé‡‘']; ti+=r['åˆ©æ¯']; }
        const pays=lastSimData.map(r=>r['æ”¯æ‰•é¡']); displayResult(lastSimData,tp,ti,pays);
      }
    });
  </script>
</body>
</html>
