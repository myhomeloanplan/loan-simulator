<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f4f8; max-width: 1000px; margin: auto; font-size: 18px; }
    h1 { text-align: center; }
    input, select, button { font-size: 1rem; }
    input[type="number"], input[type="text"], input[type="range"] {
      padding: 0.5rem; width: 100%; box-sizing: border-box;
    }
    .section-title { font-weight: bold; font-size: 20px; margin-top: 2rem; }
    .range-labels { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.3rem; }
    .inline-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
    button {
      margin-top: 1rem; padding: 1rem; width: 100%;
      background-color: #005b96; color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    #result { background: #fff; padding: 1rem; margin-top: 1.5rem; border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1); white-space: pre-line; font-size: 1rem;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; font-size: 0.9rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: right; }
    th { background-color: #e0f0ff; }
    canvas { margin-top: 2rem; }
    .rate-input-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.4rem; }
    .rate-input-row span { width: 20%; font-size: 0.95rem; }
    .rate-input-row input { width: 35%; }
  </style>
</head>
<body onload="generateRateInputs()">
  <h1>ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼0809</h1>

  <div class="section-title">å€Ÿå…¥é¡ï¼ˆå††ï¼‰</div>
  <input type="text" id="amount" value="50,000,000" oninput="syncAmountFromText()" />
  <div class="range-labels"><span>1,000ä¸‡å††</span><span>1å„„å††</span></div>
  <input type="range" id="amount-range" min="10000000" max="100000000" step="100000" value="50000000" oninput="syncAmountFromRange()" />

  <div class="section-title">è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</div>
  <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
  <div class="range-labels"><span>1å¹´</span><span>50å¹´</span></div>
  <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

  <div class="section-title">è¿”æ¸ˆæ–¹å¼</div>
  <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</label>
  <label><input type="radio" name="repaymentType" value="principalEqual" /> å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</label>

  <div class="section-title">é‡‘åˆ©</div>
  <div class="inline-group">
    <input type="number" id="bulk-rate" step="0.01" value="1.00" />
    <button type="button" onclick="applyBulkRate()">ã™ã¹ã¦ã«ä¸€æ‹¬å…¥åŠ›</button>
  </div>
  <div class="inline-group">
    <select id="from-year"></select>
    <input type="number" id="from-rate" step="0.01" />
    <button type="button" onclick="applyRateFromYear()">Nå¹´ç›®ä»¥é™ã«ä¸€æ‹¬å…¥åŠ›</button>
  </div>

  <div id="rate-inputs"></div>

  <div class="section-title">ğŸ“ˆ ãƒ‰ãƒ©ãƒƒã‚°ã§é‡‘åˆ©ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
  <p style="font-size: 0.9rem; margin-top: -1rem; color: #444;">â€»1ç‚¹ã‚’å‹•ã‹ã™ã¨ã€ãã‚Œä»¥é™ãŒæƒã„ã€å‰ã¯ãªã ã‚‰ã‹ã«å¤‰åŒ–ã—ã¾ã™</p>
  <canvas id="rateChart" height="100"></canvas>

  <button onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</button>
  <button onclick="downloadExcel()">ğŸ“¥ Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

  <div id="result"></div>

  <canvas id="balanceChart" height="100"></canvas>
  <canvas id="paymentChart" height="100"></canvas>
  <canvas id="stackedChart" height="100"></canvas>

  <div id="repayment-table"></div>

<script>
let lastSimData = [];
let rateChartInstance = null;

function syncAmountFromRange() {
  const val = parseInt(document.getElementById("amount-range").value);
  document.getElementById("amount").value = val.toLocaleString();
}
function syncAmountFromText() {
  const raw = document.getElementById("amount").value.replace(/[^\d]/g, '');
  const num = parseInt(raw || "0");
  document.getElementById("amount-range").value = num;
  document.getElementById("amount").value = num.toLocaleString();
}
function syncYearsFromRange() {
  const val = parseInt(document.getElementById("years-range").value);
  document.getElementById("years").value = val;
  generateRateInputs();
}
function syncYearsFromInput() {
  const val = parseInt(document.getElementById("years").value);
  document.getElementById("years-range").value = val;
  generateRateInputs();
}
function parseAmount(value) {
  return parseFloat(value.replace(/,/g, ""));
}

function generateRateInputs() {
  const container = document.getElementById("rate-inputs");
  container.innerHTML = "";
  const years = parseInt(document.getElementById("years").value);
  const fromYearSelect = document.getElementById("from-year");
  fromYearSelect.innerHTML = "";

  for (let y = 1; y <= years; y++) {
    const option = document.createElement("option");
    option.value = y;
    option.textContent = `${y} å¹´ç›®ä»¥é™`;
    fromYearSelect.appendChild(option);

    const row = document.createElement("div");
    row.className = "rate-input-row";

    const label = document.createElement("span");
    label.textContent = `${y}å¹´ç›®`;

    const input1 = document.createElement("input");
    const input2 = document.createElement("input");

    [input1, input2].forEach((input, i) => {
      input.type = "number";
      input.step = "0.01";
      input.value = "1.00";
      input.className = "rate-input";
      input.dataset.index = (y - 1) * 2 + i;
      input.addEventListener("input", updateRateChartFromInputs);
    });

    row.appendChild(label);
    row.appendChild(input1);
    row.appendChild(input2);
    container.appendChild(row);
  }

  drawRateChart();
}

function applyBulkRate() {
  const rate = parseFloat(document.getElementById("bulk-rate").value);
  if (isNaN(rate)) return alert("æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  document.querySelectorAll(".rate-input").forEach(input => {
    input.value = rate.toFixed(2);
  });
  updateRateChartFromInputs();
}

function applyRateFromYear() {
  const fromYear = parseInt(document.getElementById("from-year").value);
  const rate = parseFloat(document.getElementById("from-rate").value);
  if (isNaN(rate)) return alert("æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  const inputs = document.querySelectorAll(".rate-input");
  const startIndex = (fromYear - 1) * 2;
  for (let i = startIndex; i < inputs.length; i++) {
    inputs[i].value = rate.toFixed(2);
  }
  updateRateChartFromInputs();
}

function updateRateChartFromInputs() {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  const rates = inputs.map(input => parseFloat(input.value) || 0);
  if (rateChartInstance) {
    rateChartInstance.data.datasets[0].data = rates;
    rateChartInstance.update();
  }
}

function updateInputsFromRateChart(rates) {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  rates.forEach((r, i) => {
    inputs[i].value = parseFloat(r).toFixed(2);
  });
  simulate(); // è‡ªå‹•å†è¨ˆç®—
}

function drawRateChart() {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  const rates = inputs.map(input => parseFloat(input.value) || 0);
  const labels = rates.map((_, i) => `${Math.floor(i / 2) + 1}å¹´${i % 2 === 0 ? 'å‰' : 'å¾Œ'}`);

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (rateChartInstance) rateChartInstance.destroy();

  rateChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "åŠå¹´ã”ã¨ã®é‡‘åˆ©ï¼ˆï¼…ï¼‰",
        data: rates,
        borderColor: "#ff7f0e",
        backgroundColor: "rgba(255,127,14,0.2)",
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, suggestedMax: 5 }
      },
      plugins: {
        dragData: {
          round: 2,
          showTooltip: true,
          onDragEnd: function (e, datasetIndex, index, value) {
            const data = rateChartInstance.data.datasets[0].data;
            const newRates = [...data];
            const len = newRates.length;

            // ä»¥é™ã™ã¹ã¦åŒã˜å€¤
            for (let i = index; i < len; i++) {
              newRates[i] = value;
            }

            // ãã‚Œä»¥å‰ã‚’ãªã ã‚‰ã‹ã«
            for (let i = index - 1; i >= 0; i--) {
              const distance = index - i;
              const factor = 1 / (distance + 1);
              newRates[i] = data[i] * (1 - factor) + value * factor;
            }

            updateInputsFromRateChart(newRates);
            rateChartInstance.data.datasets[0].data = newRates;
            rateChartInstance.update();
          }
        }
      }
    },
    plugins: [Chart.registry.getPlugin('dragdata')]
  });
}

function simulate() {
  const amount = parseAmount(document.getElementById("amount").value);
  const years = parseInt(document.getElementById("years").value);
  const months = years * 12;
  const repaymentType = document.querySelector("input[name='repaymentType']:checked").value;
  const rates = Array.from(document.querySelectorAll(".rate-input")).map(el => parseFloat(el.value) / 100);

  if (rates.length < months / 6) {
    alert("é‡‘åˆ©ã®å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
    return;
  }

  let balance = amount;
  const result = [];
  let totalPrincipal = 0;
  let totalInterest = 0;

  for (let m = 0; m < months; m++) {
    const rate = rates[Math.floor(m / 6)] || 0;
    const monthlyRate = rate / 12;

    let interest = balance * monthlyRate;
    let principal;

    if (repaymentType === "principalAndInterestEqual") {
      const r = monthlyRate;
      const payment = r > 0 ? amount * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1) : amount / months;
      interest = balance * r;
      principal = payment - interest;
    } else {
      principal = amount / months;
      interest = balance * monthlyRate;
    }

    balance -= principal;
    totalPrincipal += principal;
    totalInterest += interest;

    result.push({
      æœˆ: m + 1,
      å…ƒé‡‘: Math.round(principal),
      åˆ©æ¯: Math.round(interest),
      æ®‹é«˜: Math.round(balance < 0 ? 0 : balance),
      æ”¯æ‰•é¡: Math.round(principal + interest)
    });
  }

  lastSimData = result;
  displayResult(result, totalPrincipal, totalInterest);
  drawCharts(result);
}

function displayResult(data, totalPrincipal, totalInterest) {
  const totalRepayment = Math.ceil(totalPrincipal + totalInterest);
  const interestRounded = Math.ceil(totalInterest);
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = `ğŸ ç·è¿”æ¸ˆé¡: ${totalRepayment.toLocaleString()} å††\nğŸ“Š ç·åˆ©æ¯: ${interestRounded.toLocaleString()} å††`;

  const table = document.createElement("table");
  const thead = table.createTHead();
  const tbody = table.createTBody();
  thead.innerHTML = "<tr><th>æœˆ</th><th>å…ƒé‡‘</th><th>åˆ©æ¯</th><th>æ”¯æ‰•é¡</th><th>æ®‹é«˜</th></tr>";

  data.forEach(row => {
    const tr = tbody.insertRow();
    ["æœˆ", "å…ƒé‡‘", "åˆ©æ¯", "æ”¯æ‰•é¡", "æ®‹é«˜"].forEach(key => {
      const td = tr.insertCell();
      td.textContent = row[key].toLocaleString();
    });
  });

  const container = document.getElementById("repayment-table");
  container.innerHTML = "";
  container.appendChild(table);
}

function drawCharts(data) {
  const labels = data.map(d => d["æœˆ"]);
  const principalData = data.map(d => d["å…ƒé‡‘"]);
  const interestData = data.map(d => d["åˆ©æ¯"]);
  const balanceData = data.map(d => d["æ®‹é«˜"]);
  const paymentData = data.map(d => d["æ”¯æ‰•é¡"]);

  new Chart(document.getElementById("balanceChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "ãƒ­ãƒ¼ãƒ³æ®‹é«˜", data: balanceData, borderColor: "blue", fill: false }] }
  });

  new Chart(document.getElementById("paymentChart"), {
    type: "bar",
    data: { labels, datasets: [{ label: "æœˆã€…ã®æ”¯æ‰•é¡", data: paymentData, backgroundColor: "green" }] }
  });

  new Chart(document.getElementById("stackedChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "å…ƒé‡‘", data: principalData, backgroundColor: "#4CAF50" },
        { label: "åˆ©æ¯", data: interestData, backgroundColor: "#FF9800" }
      ]
    },
    options: {
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  });
}

function downloadExcel() {
  if (!lastSimData.length) {
    alert("ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const worksheet = XLSX.utils.json_to_sheet(lastSimData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³");
  XLSX.writeFile(workbook, "loan_simulation.xlsx");
}
</script>
</body>
</html>
