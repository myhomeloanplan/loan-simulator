<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆè»½é‡å®‰å®šç‰ˆãƒ»ä¸‡å††è¡¨ç¤ºï¼‰</title>
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
Â  <style>
Â Â Â  :root{
Â Â Â Â Â  --primary:#005b96;
Â Â Â Â Â  --primary-2:#0077c2;
Â Â Â Â Â  --bg:#f0f4f8;
Â Â Â Â Â  --card:#ffffff;
Â Â Â Â Â  --muted:#5b6b7a;
Â Â Â Â Â  --ring:rgba(0,91,150,.25);
Â Â Â Â Â  --title:#0b5585;
Â Â Â  }
Â Â Â  *{box-sizing:border-box}
Â Â Â  body {
Â Â Â Â Â  font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
Â Â Â Â Â  padding: 24px;
Â Â Â Â Â  background: var(--bg);
Â Â Â Â Â  max-width: 1100px;
Â Â Â Â Â  margin: auto;
Â Â Â Â Â  font-size: 18px;
Â Â Â Â Â  color:#102a43;
Â Â Â  }
Â Â Â  h1 { text-align: center; margin-top: 4px; }

Â Â Â  .card {
Â Â Â Â Â  background: var(--card);
Â Â Â Â Â  border-radius: 14px;
Â Â Â Â Â  box-shadow: 0 6px 20px rgba(16,42,67,.06);
Â Â Â Â Â  padding: 18px;
Â Â Â Â Â  margin-top: 16px;
Â Â Â  }
Â Â Â  /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ï¼ˆæ¡ä»¶ / ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœï¼‰ã‚’åŒã˜ãƒ‡ã‚¶ã‚¤ãƒ³ã« */
Â Â Â  .panel-title{
Â Â Â Â Â  display:flex; align-items:center; gap:.6rem;
Â Â Â Â Â  font-weight:800; font-size:22px; color:var(--title); margin:2px 0 10px;
Â Â Â  }
Â Â Â  .panel-title::before{
Â Â Â Â Â  content:""; width:10px; height:10px; border-radius:2px; background:linear-gradient(135deg,var(--primary-2),var(--primary));
Â Â Â Â Â  box-shadow:0 0 0 4px rgba(0,91,150,.12);
Â Â Â  }

Â Â Â  .section-title { font-weight: 700; font-size: 18px; margin-top: 18px; }
Â Â Â  .range-labels { display: flex; justify-content: space-between; font-size: 0.9rem; margin: 6px 0 8px; color:var(--muted); }
Â Â Â  .inline-group { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
Â Â Â  input[type="number"], input[type="text"], input[type="range"], select {
Â Â Â Â Â  padding: .7rem .8rem; font-size: 1rem; width: 100%; border-radius: 10px; border:1px solid #d6e2ef; background:#fff;
Â Â Â Â Â  transition: box-shadow .15s ease, border-color .15s ease;
Â Â Â  }
Â Â Â  input[type="number"]:focus, input[type="text"]:focus, select:focus {
Â Â Â Â Â  outline:none; border-color: var(--primary-2); box-shadow: 0 0 0 4px var(--ring);
Â Â Â  }
Â Â Â  input[type="range"]{ accent-color: var(--primary-2); }

Â Â Â  /* Buttons */
Â Â Â  .actions{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:12px;}
Â Â Â  .btn {
Â Â Â Â Â  appearance:none; border:none; cursor:pointer; font-weight:700; padding:1rem;
Â Â Â Â Â  border-radius:12px; transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
Â Â Â  }
Â Â Â  .btn:active{ transform: translateY(1px); }
Â Â Â  .btn-primary{
Â Â Â Â Â  color:#fff; background: linear-gradient(135deg, var(--primary-2), var(--primary));
Â Â Â Â Â  box-shadow: 0 6px 14px rgba(0,91,150,.18);
Â Â Â  }
Â Â Â  .btn-primary:hover{ filter: brightness(1.05); box-shadow: 0 8px 18px rgba(0,91,150,.26); }
Â Â Â  .btn-ghost{
Â Â Â Â Â  background:#eef6ff; color:#0b5585; border:1px solid #cfe3f7;
Â Â Â  }

Â Â Â  .kpi{
Â Â Â Â Â  display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:12px;
Â Â Â  }
Â Â Â  .kpi .tile{
Â Â Â Â Â  background:#fff; border:1px solid #e6edf5; border-radius:12px; padding:14px;
Â Â Â  }
Â Â Â  .kpi .label{font-size:.9rem; color:#334e68;}
Â Â Â  .kpi .value{font-weight:800; font-size:1.3rem; margin-top:4px;}
Â Â Â  #result { white-space: pre-line; font-size: 1rem; }

Â Â Â  table { width: 100%; border-collapse: collapse; margin-top: 18px; font-size: 0.95rem; }
Â Â Â  th, td { border: 1px solid #e6edf5; padding: 0.6rem; text-align: right; }
Â Â Â  th { background-color: #eaf4ff; font-weight:700; }

Â Â Â  /* ã‚°ãƒ©ãƒ•ã¯ãƒ©ãƒƒãƒ‘ãƒ¼ã§ä½™ç™½ï¼†è§’ä¸¸ã€canvasã¯100%æç”» */
Â Â Â  .chart-block{ margin-top:14px; }
Â Â Â  .chart-title{ font-size: 16px; font-weight:700; color:#2b455c; margin: 6px 4px; }
Â Â Â  .chart-wrap{
Â Â Â Â Â  width:100%;
Â Â Â Â Â  height: 240px;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é«˜ã• */
Â Â Â Â Â  background:#fff;
Â Â Â Â Â  border-radius:12px;
Â Â Â Â Â  padding:10px;
Â Â Â Â Â  overflow:hidden;
Â Â Â  }
Â Â Â  .chart-wrap > canvas{
Â Â Â Â Â  display:block;
Â Â Â Â Â  width:100% !important;
Â Â Â Â Â  height:100% !important;
Â Â Â  }
Â Â Â  /* ã‚¹ãƒãƒ›ã¯åŠåˆ†ä»¥ä¸‹ */
Â Â Â  @media (max-width: 640px) {
Â Â Â Â Â  .chart-wrap{ height: 120px; }
Â Â Â  }

Â Â Â  .rate-input-row { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
Â Â Â  .rate-input-row span { width: 20%; font-size: 0.95rem; color:var(--muted); }
Â Â Â  .rate-input-row input { width: 35%; }
Â Â Â  .note{font-size:.9rem;color:var(--muted); margin-top:4px}
Â Â Â  .row-end{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px;}
Â Â Â  .hint{font-size:.9rem; color:#334e68;}
Â  </style>
</head>
<body onload="generateRateInputs()">
Â  <h1>ğŸ  ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>

Â  <!-- æ¡ä»¶ -->
Â  <div class="card">
Â Â Â  <div class="panel-title">æ¡ä»¶</div>

Â Â Â  <div class="section-title">å€Ÿå…¥é¡ï¼ˆä¸‡å††ï¼‰</div>
Â Â Â  <input type="text" id="amount" value="5000" oninput="syncAmountFromText()" />
Â Â Â  <div class="range-labels"><span>1000</span><span>10000</span></div>
Â Â Â  <input type="range" id="amount-range" min="1000" max="10000" step="10" value="5000" oninput="syncAmountFromRange()" />

Â Â Â  <div class="section-title">è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</div>
Â Â Â  <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
Â Â Â  <div class="range-labels"><span>1</span><span>50</span></div>
Â Â Â  <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

Â Â Â  <div class="section-title">è¿”æ¸ˆæ–¹å¼</div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</label>
Â Â Â Â Â  <label><input type="radio" name="repaymentType" value="principalEqual" /> å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</label>
Â Â Â  </div>

Â Â Â  <div class="section-title">é‡‘åˆ©ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <input type="number" id="bulk-rate" step="0.01" value="1.00" />
Â Â Â Â Â  <button type="button" class="btn btn-ghost" onclick="applyBulkRate()">ã™ã¹ã¦ã«ä¸€æ‹¬å…¥åŠ›</button>
Â Â Â  </div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <select id="from-year"></select>
Â Â Â Â Â  <input type="number" id="from-rate" step="0.01" />
Â Â Â Â Â  <button type="button" class="btn btn-ghost" onclick="applyRateFromYear()">Nå¹´ç›®ä»¥é™ã«ä¸€æ‹¬å…¥åŠ›</button>
Â Â Â  </div>

Â Â Â  <div id="rate-inputs"></div>

Â Â Â  <div class="section-title">ğŸ“ˆ ãƒ‰ãƒ©ãƒƒã‚°ã§é‡‘åˆ©ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
Â Â Â  <p class="note">ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ã€Œãã®ç‚¹ä»¥é™ã¯åŒã˜é‡‘åˆ©ã€ã€Œãã‚Œä»¥å‰ã¯ç›´å‰3ãƒã‚¤ãƒ³ãƒˆï¼ˆ=1.5å¹´ï¼‰ã ã‘ãªã ã‚‰ã‹ã«è¿‘ã¥ãã€</p>
Â Â Â  <div class="chart-wrap"><canvas id="rateChart"></canvas></div>

Â Â Â  <div class="actions">
Â Â Â Â Â  <button class="btn btn-primary" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</button>
Â Â Â  </div>
Â  </div>

Â  <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ -->
Â  <div class="card">
Â Â Â  <div class="panel-title">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
Â Â Â  <div id="result"></div>

Â Â Â  <div class="kpi" id="kpiTiles" style="display:none;">
Â Â Â Â Â  <div class="tile">
Â Â Â Â Â Â Â  <div class="label">åˆæœˆã®æœˆã€…è¿”æ¸ˆé¡</div>
Â Â Â Â Â Â Â  <div class="value" id="kpi-first"></div>
Â Â Â Â Â  </div>
Â Â Â Â Â  <div class="tile">
Â Â Â Â Â Â Â  <div class="label">å¹³å‡ã®æœˆã€…è¿”æ¸ˆé¡</div>
Â Â Â Â Â Â Â  <div class="value" id="kpi-avg"></div>
Â Â Â Â Â  </div>
Â Â Â Â Â  <div class="tile">
Â Â Â Â Â Â Â  <div class="label">æœ€å¤§ã®æœˆã€…è¿”æ¸ˆé¡</div>
Â Â Â Â Â Â Â  <div class="value" id="kpi-max"></div>
Â Â Â Â Â  </div>
Â Â Â  </div>

Â Â Â  <div class="chart-block">
Â Â Â Â Â  <div class="chart-title">æœˆã€…ã®æ”¯æ‰•é¡</div>
Â Â Â Â Â  <div class="chart-wrap"><canvas id="paymentChart"></canvas></div>
Â Â Â  </div>
Â Â Â  <div class="chart-block">
Â Â Â Â Â  <div class="chart-title">æ”¯æ‰•å†…è¨³ï¼ˆå…ƒé‡‘/åˆ©æ¯ï¼‰</div>
Â Â Â Â Â  <div class="chart-wrap"><canvas id="stackedChart"></canvas></div>
Â Â Â  </div>

Â Â Â  <div class="row-end">
Â Â Â Â Â  <label class="hint"><input type="checkbox" id="toggle-table" checked> æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º</label>
Â Â Â Â Â  <span class="hint">â€»ã‚ªãƒ•ã«ã™ã‚‹ã¨è»½ããªã‚Šã¾ã™</span>
Â Â Â  </div>
Â Â Â  <div id="repayment-table"></div>

Â Â Â  <div class="actions">
Â Â Â Â Â  <button class="btn btn-ghost" onclick="downloadExcel()">ğŸ“¥ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’Excelã§ä¿å­˜</button>
Â Â Â  </div>
Â  </div>

Â  <script>
Â  // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ« =========
Â  let lastSimData = [];
Â  let rateChartInstance = null;
Â  let paymentChart = null, stackedChart = null;

Â  // ========= å…¥å‡ºåŠ›åŒæœŸï¼ˆä¸‡å††ï¼‰ =========
Â  function syncAmountFromRange() {
Â Â Â  const val = parseInt(document.getElementById('amount-range').value);
Â Â Â  document.getElementById('amount').value = val.toLocaleString();
Â  }
Â  function syncAmountFromText() {
Â Â Â  const raw = document.getElementById('amount').value.replace(/[^\d]/g, '');
Â Â Â  const num = parseInt(raw || '0');
Â Â Â  document.getElementById('amount-range').value = num;
Â Â Â  document.getElementById('amount').value = num.toLocaleString();
Â  }
Â  function syncYearsFromRange() {
Â Â Â  const val = parseInt(document.getElementById('years-range').value);
Â Â Â  document.getElementById('years').value = val;
Â Â Â  generateRateInputs();
Â  }
Â  function syncYearsFromInput() {
Â Â Â  const val = parseInt(document.getElementById('years').value);
Â Â Â  document.getElementById('years-range').value = val;
Â Â Â  generateRateInputs();
Â  }
Â  function parseAmount(v) { return parseFloat(v.replace(/,/g, '')) * 10000; } // ä¸‡å†† â†’ å††

Â  // ========= é‡‘åˆ©å…¥åŠ›ç”Ÿæˆ =========
Â  function generateRateInputs() {
Â Â Â  const container = document.getElementById('rate-inputs');
Â Â Â  container.innerHTML = '';
Â Â Â  const years = parseInt(document.getElementById('years').value);
Â Â Â  const fromYearSelect = document.getElementById('from-year');
Â Â Â  fromYearSelect.innerHTML = '';

Â Â Â  for (let y = 1; y <= years; y++) {
Â Â Â Â Â  const option = document.createElement('option');
Â Â Â Â Â  option.value = y; option.textContent = `${y} å¹´ç›®ä»¥é™`; fromYearSelect.appendChild(option);

Â Â Â Â Â  const row = document.createElement('div'); row.className = 'rate-input-row';
Â Â Â Â Â  const label = document.createElement('span'); label.textContent = `${y}å¹´ç›®`;
Â Â Â Â Â  const input1 = document.createElement('input'); const input2 = document.createElement('input');
Â Â Â Â Â  [input1, input2].forEach((input, i) => {
Â Â Â Â Â Â Â  input.type = 'number'; input.step = '0.01'; input.value = '1.00'; input.className = 'rate-input';
Â Â Â Â Â Â Â  input.dataset.index = (y - 1) * 2 + i; input.addEventListener('input', updateRateChartFromInputs);
Â Â Â Â Â  });
Â Â Â Â Â  row.appendChild(label); row.appendChild(input1); row.appendChild(input2); container.appendChild(row);
Â Â Â  }
Â Â Â  drawRateChart();
Â  }

Â  // ========= å…¥åŠ› â†’ ã‚°ãƒ©ãƒ•åæ˜  =========
Â  function updateRateChartFromInputs() {
Â Â Â  const inputs = Array.from(document.querySelectorAll('.rate-input'));
Â Â Â  const rates = inputs.map(el => parseFloat(el.value) || 0);
Â Â Â  if (rateChartInstance) {
Â Â Â Â Â  // ãƒ©ãƒ™ãƒ«ã¯ã€ŒNå¹´ç›®ã€
Â Â Â Â Â  rateChartInstance.data.labels = rates.map((_, i) => `${Math.floor(i / 2) + 1}å¹´ç›®`);
Â Â Â Â Â  rateChartInstance.data.datasets[0].data = rates;
Â Â Â Â Â  rateChartInstance.update();
Â Â Â  }
Â  }

Â  // ========= ã‚°ãƒ©ãƒ• â†’ å…¥åŠ›åæ˜  =========
Â  function updateInputsFromRateChart(rates) {
Â Â Â  const inputs = document.querySelectorAll('.rate-input');
Â Â Â  rates.forEach((r, i) => { inputs[i].value = parseFloat(r).toFixed(2); });
Â Â Â  simulate(); // ã‚°ãƒ©ãƒ•å¤‰æ›´æ™‚ã¯å³å†è¨ˆç®—
Â  }

Â  // ========= é‡‘åˆ©ä¸€æ‹¬é©ç”¨ =========
Â  function applyBulkRate() {
Â Â Â  const rate = parseFloat(document.getElementById('bulk-rate').value);
Â Â Â  if (isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
Â Â Â  document.querySelectorAll('.rate-input').forEach(inp => inp.value = rate.toFixed(2));
Â Â Â  updateRateChartFromInputs();
Â  }
Â  function applyRateFromYear() {
Â Â Â  const fromYear = parseInt(document.getElementById('from-year').value);
Â Â Â  const rate = parseFloat(document.getElementById('from-rate').value);
Â Â Â  if (isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
Â Â Â  const inputs = document.querySelectorAll('.rate-input');
Â Â Â  const startIndex = (fromYear - 1) * 2;
Â Â Â  for (let i = startIndex; i < inputs.length; i++) inputs[i].value = rate.toFixed(2);
Â Â Â  updateRateChartFromInputs();
Â  }

Â  // ========= ãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œã‚°ãƒ©ãƒ• =========
Â  function drawRateChart() {
Â Â Â  const inputs = Array.from(document.querySelectorAll('.rate-input'));
Â Â Â  const rates = inputs.map(el => parseFloat(el.value) || 0);
Â Â Â  const labels = rates.map((_, i) => `${Math.floor(i / 2) + 1}å¹´ç›®`);

Â Â Â  const ctx = document.getElementById('rateChart').getContext('2d');
Â Â Â  if (rateChartInstance) rateChartInstance.destroy();

Â Â Â  rateChartInstance = new Chart(ctx, {
Â Â Â Â Â  type: 'line',
Â Â Â Â Â  data: {
Â Â Â Â Â Â Â  labels,
Â Â Â Â Â Â Â  datasets: [{
Â Â Â Â Â Â Â Â Â  label: 'åŠå¹´ã”ã¨ã®é‡‘åˆ©ï¼ˆï¼…ï¼‰',
Â Â Â Â Â Â Â Â Â  data: rates,
Â Â Â Â Â Â Â Â Â  borderColor: '#ff7f0e',
Â Â Â Â Â Â Â Â Â  backgroundColor: 'rgba(255,127,14,0.12)',
Â Â Â Â Â Â Â Â Â  pointRadius: 4,
Â Â Â Â Â Â Â Â Â  pointHoverRadius: 6,
Â Â Â Â Â Â Â Â Â  pointHitRadius: 14,
Â Â Â Â Â Â Â Â Â  borderWidth: 3,
Â Â Â Â Â Â Â Â Â  tension: 0.15
Â Â Â Â Â Â Â  }]
Â Â Â Â Â  },
Â Â Â Â Â  options: {
Â Â Â Â Â Â Â  responsive: true,
Â Â Â Â Â Â Â  maintainAspectRatio: false,
Â Â Â Â Â Â Â  animation: false,
Â Â Â Â Â Â Â  scales: {
Â Â Â Â Â Â Â Â Â  x: {
Â Â Â Â Â Â Â Â Â Â Â  grid: { display: false },
Â Â Â Â Â Â Â Â Â Â Â  ticks: {
Â Â Â Â Â Â Â Â Â Â Â Â Â  maxRotation: 0,
Â Â Â Â Â Â Â Â Â Â Â Â Â  font: { size: 14 },
Â Â Â Â Â Â Â Â Â Â Â Â Â  callback: (value, index, ticks) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const total = ticks.length;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const every = Math.max(1, Math.floor(total / (window.innerWidth < 640 ? 8 : 12)));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return (index % every === 0) ? labels[index] : '';
Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â  y: {
Â Â Â Â Â Â Â Â Â Â Â  beginAtZero: true,
Â Â Â Â Â Â Â Â Â Â Â  suggestedMax: 5,
Â Â Â Â Â Â Â Â Â Â Â  grid: { color: 'rgba(0,0,0,0.08)' },
Â Â Â Â Â Â Â Â Â Â Â  ticks: {
Â Â Â Â Â Â Â Â Â Â Â Â Â  font: { size: 14 },
Â Â Â Â Â Â Â Â Â Â Â Â Â  callback: v => Number(v).toFixed(1) + '%'
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  plugins: {
Â Â Â Â Â Â Â Â Â  legend: { display: false },
Â Â Â Â Â Â Â Â Â  tooltip: {
Â Â Â Â Â Â Â Â Â Â Â  callbacks: {
Â Â Â Â Â Â Â Â Â Â Â Â Â  title: ctx => labels[ctx[0].dataIndex],
Â Â Â Â Â Â Â Â Â Â Â Â Â  label: ctx => `é‡‘åˆ©: ${Number(ctx.parsed.y).toFixed(2)}%`
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â  dragData: {
Â Â Â Â Â Â Â Â Â Â Â  round: 2,
Â Â Â Â Â Â Â Â Â Â Â  showTooltip: true,
Â Â Â Â Â Â Â Â Â Â Â  onDragEnd: function (e, datasetIndex, index, value) {
Â Â Â Â Â Â Â Â Â Â Â Â Â  const oldData = rateChartInstance.data.datasets[0].data;
Â Â Â Â Â Â Â Â Â Â Â Â Â  const newRates = [...oldData];
Â Â Â Â Â Â Â Â Â Â Â Â Â  const len = newRates.length;
Â Â Â Â Â Â Â Â Â Â Â Â Â  const SMOOTH_PRE_RANGE = 3; // ç›´å‰3ãƒã‚¤ãƒ³ãƒˆï¼ˆ=1.5å¹´ï¼‰

Â Â Â Â Â Â Â Â Â Â Â Â Â  // ä»¥é™ã‚’åŒã˜å€¤ã«å›ºå®š
Â Â Â Â Â Â Â Â Â Â Â Â Â  for (let i = index; i < len; i++) newRates[i] = value;
Â Â Â Â Â Â Â Â Â Â Â Â Â  // ç›´å‰3ãƒã‚¤ãƒ³ãƒˆã ã‘ç·šå½¢ã§ãªã ã‚‰ã‹ã«
Â Â Â Â Â Â Â Â Â Â Â Â Â  const start = Math.max(0, index - SMOOTH_PRE_RANGE);
Â Â Â Â Â Â Â Â Â Â Â Â Â  const span = index - start;
Â Â Â Â Â Â Â Â Â Â Â Â Â  if (span > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  for (let i = start; i < index; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const t = (i - start + 1) / span;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  newRates[i] = oldData[i] * (1 - t) + value * t;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â  updateInputsFromRateChart(newRates);
Â Â Â Â Â Â Â Â Â Â Â Â Â  rateChartInstance.data.datasets[0].data = newRates;
Â Â Â Â Â Â Â Â Â Â Â Â Â  rateChartInstance.update();
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â  },
Â Â Â Â Â  plugins: [Chart.registry.getPlugin('dragdata')]
Â Â Â  });
Â  }

Â  // ========= ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ«ãƒ¼ãƒ«ãªã—ï¼‰ =========
Â  function simulate() {
Â Â Â  const amount = parseAmount(document.getElementById('amount').value); // å††
Â Â Â  const years = parseInt(document.getElementById('years').value);
Â Â Â  const months = years * 12;
Â Â Â  const repaymentType = document.querySelector("input[name='repaymentType']:checked").value;
Â Â Â  const rates = Array.from(document.querySelectorAll('.rate-input')).map(el => parseFloat(el.value) / 100);

Â Â Â  if (!amount || !years) { alert('å€Ÿå…¥é¡ã¨è¿”æ¸ˆæœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
Â Â Â  if (rates.length < Math.ceil(months / 6)) { alert('é‡‘åˆ©ã®å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'); return; }

Â Â Â  let balance = amount;
Â Â Â  const result = [];
Â Â Â  const payments = [];
Â Â Â  let totalPrincipal = 0, totalInterest = 0;

Â Â Â  for (let m = 0; m < months; m++) {
Â Â Â Â Â  const rateIdx = Math.floor(m / 6);
Â Â Â Â Â  const annualRate = rates[rateIdx] || 0;Â Â Â Â Â  // å¹´åˆ©(å°æ•°)
Â Â Â Â Â  const r = annualRate / 12;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // æœˆåˆ©
Â Â Â Â Â  const remain = months - m;

Â Â Â Â Â  let interest = balance * r;
Â Â Â Â Â  let principal, paymentOut;

Â Â Â Â Â  if (repaymentType === 'principalAndInterestEqual') {
Â Â Â Â Â Â Â  // ãƒ«ãƒ¼ãƒ«ãªã—ï¼šæ¯æœˆãã®æœˆã®é‡‘åˆ©ï¼†æ®‹æœŸé–“ã§ç†è«–è¿”æ¸ˆé¡ã‚’å†è¨ˆç®—
Â Â Â Â Â Â Â  paymentOut = r > 0
Â Â Â Â Â Â Â Â Â  ? balance * r * Math.pow(1 + r, remain) / (Math.pow(1 + r, remain) - 1)
Â Â Â Â Â Â Â Â Â  : balance / remain;
Â Â Â Â Â Â Â  interest = balance * r;
Â Â Â Â Â Â Â  principal = paymentOut - interest;
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  principal = amount / months;
Â Â Â Â Â Â Â  interest = balance * r;
Â Â Â Â Â Â Â  paymentOut = principal + interest;
Â Â Â Â Â  }

Â Â Â Â Â  balance -= principal;
Â Â Â Â Â  if (balance < 0) balance = 0;
Â Â Â Â Â  totalPrincipal += principal;
Â Â Â Â Â  totalInterest += interest;
Â Â Â Â Â  payments.push(paymentOut);

Â Â Â Â Â  result.push({
Â Â Â Â Â Â Â  æœˆ: m + 1,
Â Â Â Â Â Â Â  å…ƒé‡‘: Math.round(principal),
Â Â Â Â Â Â Â  åˆ©æ¯: Math.round(interest),
Â Â Â Â Â Â Â  æ®‹é«˜: Math.round(balance),
Â Â Â Â Â Â Â  æ”¯æ‰•é¡: Math.round(paymentOut)
Â Â Â Â Â  });
Â Â Â  }

Â Â Â  lastSimData = result;
Â Â Â  displayResult(result, totalPrincipal, totalInterest, payments);
Â Â Â  drawCharts(result);
Â  }

Â  // ========= çµæœè¡¨ç¤ºï¼ˆç·é¡ï¼‹æœˆã®è¿”æ¸ˆé¡KPIï¼‰ =========
Â  function displayResult(data, totalPrincipal, totalInterest, payments) {
Â Â Â  const totalRepayment = Math.ceil(totalPrincipal + totalInterest); // ç·è¿”æ¸ˆé¡ï¼šåˆ‡ã‚Šä¸Šã’
Â Â Â  const interestRounded = Math.ceil(totalInterest);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // ç·åˆ©æ¯ï¼šåˆ‡ã‚Šä¸Šã’
Â Â Â  const firstPay = Math.round(payments[0] || 0);
Â Â Â  const avgPay = Math.round(payments.reduce((a,b)=>a+b,0) / payments.length || 0);
Â Â Â  const maxPay = Math.round(Math.max(...payments, 0));

Â Â Â  const div = document.getElementById('result');
Â Â Â  div.innerHTML = `ğŸ ç·è¿”æ¸ˆé¡: ${totalRepayment.toLocaleString()} å††\nğŸ“Š ç·åˆ©æ¯: ${interestRounded.toLocaleString()} å††`;

Â Â Â  // KPIã‚¿ã‚¤ãƒ«
Â Â Â  document.getElementById('kpiTiles').style.display = 'grid';
Â Â Â  document.getElementById('kpi-first').textContent = `${firstPay.toLocaleString()} å††`;
Â Â Â  document.getElementById('kpi-avg').textContentÂ Â  = `${avgPay.toLocaleString()} å††`;
Â Â Â  document.getElementById('kpi-max').textContentÂ Â  = `${maxPay.toLocaleString()} å††`;

Â Â Â  // æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰
Â Â Â  const showTable = document.getElementById('toggle-table').checked;
Â Â Â  const tableWrap = document.getElementById('repayment-table');
Â Â Â  tableWrap.innerHTML = '';
Â Â Â  if (showTable) {
Â Â Â Â Â  const table = document.createElement('table');
Â Â Â Â Â  const thead = table.createTHead();
Â Â Â Â Â  const tbody = table.createTBody();
Â Â Â Â Â  thead.innerHTML = '<tr><th>æœˆ</th><th>å…ƒé‡‘</th><th>åˆ©æ¯</th><th>æ”¯æ‰•é¡</th><th>æ®‹é«˜</th></tr>';
Â Â Â Â Â  for (let i=0;i<data.length;i++){
Â Â Â Â Â Â Â  const row = data[i];
Â Â Â Â Â Â Â  const tr = tbody.insertRow();
Â Â Â Â Â Â Â  const cols = ['æœˆ','å…ƒé‡‘','åˆ©æ¯','æ”¯æ‰•é¡','æ®‹é«˜'];
Â Â Â Â Â Â Â  for (let c=0;c<cols.length;c++){
Â Â Â Â Â Â Â Â Â  const td = tr.insertCell();
Â Â Â Â Â Â Â Â Â  td.textContent = row[cols[c]].toLocaleString();
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }
Â Â Â Â Â  tableWrap.appendChild(table);
Â Â Â  }
Â  }

Â  // ========= ã‚°ãƒ©ãƒ•æç”»ï¼ˆä¸‹2ã¤ï¼šYè»¸ã®æœ€å°å€¤ã‚’0ã«å›ºå®šï¼‰ =========
Â  function drawCharts(data) {
Â Â Â  const labels = data.map(d => d['æœˆ']);
Â Â Â  const principalData = data.map(d => d['å…ƒé‡‘']);
Â Â Â  const interestData = data.map(d => d['åˆ©æ¯']);
Â Â Â  const paymentData = data.map(d => d['æ”¯æ‰•é¡']);

Â Â Â  if (paymentChart) paymentChart.destroy();
Â Â Â  if (stackedChart) stackedChart.destroy();

Â Â Â  const axisFont = { size: 14 };
Â Â Â  const common = {
Â Â Â Â Â  responsive:true,
Â Â Â Â Â  maintainAspectRatio:false,
Â Â Â Â Â  animation:false,
Â Â Â Â Â  scales: {
Â Â Â Â Â Â Â  x: { ticks: { maxRotation:0, autoSkip:true, autoSkipPadding:16, font:axisFont }, grid:{display:false} },
Â Â Â Â Â Â Â  y: { 
Â Â Â Â Â Â Â Â Â  ticks: { font:axisFont }, 
Â Â Â Â Â Â Â Â Â  grid:{ color:'rgba(0,0,0,0.08)' },
Â Â Â Â Â Â Â Â Â  beginAtZero: true,
Â Â Â Â Â Â Â Â Â  min: 0
Â Â Â Â Â Â Â  }
Â Â Â Â Â  },
Â Â Â Â Â  plugins: { legend:{display:false} }
Â Â Â  };

Â Â Â  paymentChart = new Chart(document.getElementById('paymentChart').getContext('2d'), {
Â Â Â Â Â  type: 'bar',
Â Â Â Â Â  data: { labels, datasets: [{ label: 'æœˆã€…ã®æ”¯æ‰•é¡', data: paymentData, backgroundColor: '#3fa7ff' }] },
Â Â Â Â Â  options: common
Â Â Â  });
Â Â Â  stackedChart = new Chart(document.getElementById('stackedChart').getContext('2d'), {
Â Â Â Â Â  type: 'bar',
Â Â Â Â Â  data: { labels, datasets: [
Â Â Â Â Â Â Â  { label: 'å…ƒé‡‘', data: principalData, backgroundColor: '#4CAF50' },
Â Â Â Â Â Â Â  { label: 'åˆ©æ¯', data: interestData, backgroundColor: '#FF9800' }
Â Â Â Â Â  ] },
Â Â Â Â Â  options: { 
Â Â Â Â Â Â Â  ...common, 
Â Â Â Â Â Â Â  scales: { 
Â Â Â Â Â Â Â Â Â  ...common.scales, 
Â Â Â Â Â Â Â Â Â  x:{ ...common.scales.x, stacked:true }, 
Â Â Â Â Â Â Â Â Â  y:{ ...common.scales.y, stacked:true, beginAtZero:true, min:0 }
Â Â Â Â Â Â Â  } 
Â Â Â Â Â  }
Â Â Â  });
Â  }

Â  // ========= Excelå‡ºåŠ› =========
Â  function downloadExcel() {
Â Â Â  if (!lastSimData.length) { alert('ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return; }
Â Â Â  const ws = XLSX.utils.json_to_sheet(lastSimData);
Â Â Â  const wb = XLSX.utils.book_new();
Â Â Â  XLSX.utils.book_append_sheet(wb, ws, 'è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³');
Â Â Â  XLSX.writeFile(wb, 'loan_simulation.xlsx');
Â  }

Â  // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºãƒˆã‚°ãƒ«æ™‚ã¯å†æç”»ã®ã¿
Â  document.addEventListener('change', (e)=>{
Â Â Â  if (e.target && e.target.id === 'toggle-table' && lastSimData.length){
Â Â Â Â Â  let totalPrincipal=0,totalInterest=0;
Â Â Â Â Â  for(const r of lastSimData){ totalPrincipal+=r['å…ƒé‡‘']; totalInterest+=r['åˆ©æ¯']; }
Â Â Â Â Â  const payments = lastSimData.map(r=>r['æ”¯æ‰•é¡']);
Â Â Â Â Â  displayResult(lastSimData, totalPrincipal, totalInterest, payments);
Â Â Â  }
Â  });
Â  </script>
</body>
</html>
