<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>住宅ローンシミュレーター</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f4f8; max-width: 1000px; margin: auto; font-size: 18px; }
    h1 { text-align: center; }
    input, select, button { font-size: 1rem; }
    input[type="number"], input[type="text"], input[type="range"] {
      padding: 0.5rem; width: 100%; box-sizing: border-box;
    }
    .section-title { font-weight: bold; font-size: 20px; margin-top: 2rem; }
    .range-labels { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.3rem; }
    .inline-group { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
    button {
      margin-top: 1rem; padding: 1rem; width: 100%;
      background-color: #005b96; color: white; border: none; border-radius: 4px; cursor: pointer;
    }
    #result { background: #fff; padding: 1rem; margin-top: 1.5rem; border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1); white-space: pre-line; font-size: 1rem;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; font-size: 0.9rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: right; }
    th { background-color: #e0f0ff; }
    canvas { margin-top: 2rem; }
    .rate-input-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.4rem; }
    .rate-input-row span { width: 20%; font-size: 0.95rem; }
    .rate-input-row input { width: 35%; }
  </style>
</head>
<body onload="generateRateInputs()">
  <h1>🏠 住宅ローンシミュレーター0809</h1>

  <div class="section-title">借入額（円）</div>
  <input type="text" id="amount" value="50,000,000" oninput="syncAmountFromText()" />
  <div class="range-labels"><span>1,000万円</span><span>1億円</span></div>
  <input type="range" id="amount-range" min="10000000" max="100000000" step="100000" value="50000000" oninput="syncAmountFromRange()" />

  <div class="section-title">返済期間（年）</div>
  <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
  <div class="range-labels"><span>1年</span><span>50年</span></div>
  <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

  <div class="section-title">返済方式</div>
  <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> 元利均等返済</label>
  <label><input type="radio" name="repaymentType" value="principalEqual" /> 元金均等返済</label>

  <div class="section-title">金利</div>
  <div class="inline-group">
    <input type="number" id="bulk-rate" step="0.01" value="1.00" />
    <button type="button" onclick="applyBulkRate()">すべてに一括入力</button>
  </div>
  <div class="inline-group">
    <select id="from-year"></select>
    <input type="number" id="from-rate" step="0.01" />
    <button type="button" onclick="applyRateFromYear()">N年目以降に一括入力</button>
  </div>

  <div id="rate-inputs"></div>

  <div class="section-title">📈 ドラッグで金利編集（半年ごと）</div>
  <p style="font-size: 0.9rem; margin-top: -1rem; color: #444;">※1点を動かすと、それ以降が揃い、前はなだらかに変化します</p>
  <canvas id="rateChart" height="100"></canvas>

  <button onclick="simulate()">シミュレーションする</button>
  <button onclick="downloadExcel()">📥 Excelダウンロード</button>

  <div id="result"></div>

  <canvas id="balanceChart" height="100"></canvas>
  <canvas id="paymentChart" height="100"></canvas>
  <canvas id="stackedChart" height="100"></canvas>

  <div id="repayment-table"></div>

<script>
let lastSimData = [];
let rateChartInstance = null;

function syncAmountFromRange() {
  const val = parseInt(document.getElementById("amount-range").value);
  document.getElementById("amount").value = val.toLocaleString();
}
function syncAmountFromText() {
  const raw = document.getElementById("amount").value.replace(/[^\d]/g, '');
  const num = parseInt(raw || "0");
  document.getElementById("amount-range").value = num;
  document.getElementById("amount").value = num.toLocaleString();
}
function syncYearsFromRange() {
  const val = parseInt(document.getElementById("years-range").value);
  document.getElementById("years").value = val;
  generateRateInputs();
}
function syncYearsFromInput() {
  const val = parseInt(document.getElementById("years").value);
  document.getElementById("years-range").value = val;
  generateRateInputs();
}
function parseAmount(value) {
  return parseFloat(value.replace(/,/g, ""));
}

function generateRateInputs() {
  const container = document.getElementById("rate-inputs");
  container.innerHTML = "";
  const years = parseInt(document.getElementById("years").value);
  const fromYearSelect = document.getElementById("from-year");
  fromYearSelect.innerHTML = "";

  for (let y = 1; y <= years; y++) {
    const option = document.createElement("option");
    option.value = y;
    option.textContent = `${y} 年目以降`;
    fromYearSelect.appendChild(option);

    const row = document.createElement("div");
    row.className = "rate-input-row";

    const label = document.createElement("span");
    label.textContent = `${y}年目`;

    const input1 = document.createElement("input");
    const input2 = document.createElement("input");

    [input1, input2].forEach((input, i) => {
      input.type = "number";
      input.step = "0.01";
      input.value = "1.00";
      input.className = "rate-input";
      input.dataset.index = (y - 1) * 2 + i;
      input.addEventListener("input", updateRateChartFromInputs);
    });

    row.appendChild(label);
    row.appendChild(input1);
    row.appendChild(input2);
    container.appendChild(row);
  }

  drawRateChart();
}

function applyBulkRate() {
  const rate = parseFloat(document.getElementById("bulk-rate").value);
  if (isNaN(rate)) return alert("有効な金利を入力してください。");
  document.querySelectorAll(".rate-input").forEach(input => {
    input.value = rate.toFixed(2);
  });
  updateRateChartFromInputs();
}

function applyRateFromYear() {
  const fromYear = parseInt(document.getElementById("from-year").value);
  const rate = parseFloat(document.getElementById("from-rate").value);
  if (isNaN(rate)) return alert("有効な金利を入力してください。");
  const inputs = document.querySelectorAll(".rate-input");
  const startIndex = (fromYear - 1) * 2;
  for (let i = startIndex; i < inputs.length; i++) {
    inputs[i].value = rate.toFixed(2);
  }
  updateRateChartFromInputs();
}

function updateRateChartFromInputs() {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  const rates = inputs.map(input => parseFloat(input.value) || 0);
  if (rateChartInstance) {
    rateChartInstance.data.datasets[0].data = rates;
    rateChartInstance.update();
  }
}

function updateInputsFromRateChart(rates) {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  rates.forEach((r, i) => {
    inputs[i].value = parseFloat(r).toFixed(2);
  });
  simulate(); // 自動再計算
}

function drawRateChart() {
  const inputs = Array.from(document.querySelectorAll(".rate-input"));
  const rates = inputs.map(input => parseFloat(input.value) || 0);
  const labels = rates.map((_, i) => `${Math.floor(i / 2) + 1}年${i % 2 === 0 ? '前' : '後'}`);

  const ctx = document.getElementById("rateChart").getContext("2d");
  if (rateChartInstance) rateChartInstance.destroy();

  rateChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "半年ごとの金利（％）",
        data: rates,
        borderColor: "#ff7f0e",
        backgroundColor: "rgba(255,127,14,0.2)",
        pointRadius: 6,
        pointHoverRadius: 8
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, suggestedMax: 5 }
      },
      plugins: {
        dragData: {
          round: 2,
          showTooltip: true,
          onDragEnd: function (e, datasetIndex, index, value) {
            const data = rateChartInstance.data.datasets[0].data;
            const newRates = [...data];
            const len = newRates.length;

            // 以降すべて同じ値
            for (let i = index; i < len; i++) {
              newRates[i] = value;
            }

            // それ以前をなだらかに
            for (let i = index - 1; i >= 0; i--) {
              const distance = index - i;
              const factor = 1 / (distance + 1);
              newRates[i] = data[i] * (1 - factor) + value * factor;
            }

            updateInputsFromRateChart(newRates);
            rateChartInstance.data.datasets[0].data = newRates;
            rateChartInstance.update();
          }
        }
      }
    },
    plugins: [Chart.registry.getPlugin('dragdata')]
  });
}

function simulate() {
  const amount = parseAmount(document.getElementById("amount").value);
  const years = parseInt(document.getElementById("years").value);
  const months = years * 12;
  const repaymentType = document.querySelector("input[name='repaymentType']:checked").value;
  const rates = Array.from(document.querySelectorAll(".rate-input")).map(el => parseFloat(el.value) / 100);

  if (rates.length < months / 6) {
    alert("金利の入力が不足しています。");
    return;
  }

  let balance = amount;
  const result = [];
  let totalPrincipal = 0;
  let totalInterest = 0;

  for (let m = 0; m < months; m++) {
    const rate = rates[Math.floor(m / 6)] || 0;
    const monthlyRate = rate / 12;

    let interest = balance * monthlyRate;
    let principal;

    if (repaymentType === "principalAndInterestEqual") {
      const r = monthlyRate;
      const payment = r > 0 ? amount * r * Math.pow(1 + r, months) / (Math.pow(1 + r, months) - 1) : amount / months;
      interest = balance * r;
      principal = payment - interest;
    } else {
      principal = amount / months;
      interest = balance * monthlyRate;
    }

    balance -= principal;
    totalPrincipal += principal;
    totalInterest += interest;

    result.push({
      月: m + 1,
      元金: Math.round(principal),
      利息: Math.round(interest),
      残高: Math.round(balance < 0 ? 0 : balance),
      支払額: Math.round(principal + interest)
    });
  }

  lastSimData = result;
  displayResult(result, totalPrincipal, totalInterest);
  drawCharts(result);
}

function displayResult(data, totalPrincipal, totalInterest) {
  const totalRepayment = Math.ceil(totalPrincipal + totalInterest);
  const interestRounded = Math.ceil(totalInterest);
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = `🏁 総返済額: ${totalRepayment.toLocaleString()} 円\n📊 総利息: ${interestRounded.toLocaleString()} 円`;

  const table = document.createElement("table");
  const thead = table.createTHead();
  const tbody = table.createTBody();
  thead.innerHTML = "<tr><th>月</th><th>元金</th><th>利息</th><th>支払額</th><th>残高</th></tr>";

  data.forEach(row => {
    const tr = tbody.insertRow();
    ["月", "元金", "利息", "支払額", "残高"].forEach(key => {
      const td = tr.insertCell();
      td.textContent = row[key].toLocaleString();
    });
  });

  const container = document.getElementById("repayment-table");
  container.innerHTML = "";
  container.appendChild(table);
}

function drawCharts(data) {
  const labels = data.map(d => d["月"]);
  const principalData = data.map(d => d["元金"]);
  const interestData = data.map(d => d["利息"]);
  const balanceData = data.map(d => d["残高"]);
  const paymentData = data.map(d => d["支払額"]);

  new Chart(document.getElementById("balanceChart"), {
    type: "line",
    data: { labels, datasets: [{ label: "ローン残高", data: balanceData, borderColor: "blue", fill: false }] }
  });

  new Chart(document.getElementById("paymentChart"), {
    type: "bar",
    data: { labels, datasets: [{ label: "月々の支払額", data: paymentData, backgroundColor: "green" }] }
  });

  new Chart(document.getElementById("stackedChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "元金", data: principalData, backgroundColor: "#4CAF50" },
        { label: "利息", data: interestData, backgroundColor: "#FF9800" }
      ]
    },
    options: {
      scales: { x: { stacked: true }, y: { stacked: true } }
    }
  });
}

function downloadExcel() {
  if (!lastSimData.length) {
    alert("まずシミュレーションを実行してください。");
    return;
  }
  const worksheet = XLSX.utils.json_to_sheet(lastSimData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "返済シミュレーション");
  XLSX.writeFile(workbook, "loan_simulation.xlsx");
}
</script>
</body>
</html>
