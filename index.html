<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>住宅ローンシミュレーター</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #f0f4f8;
      max-width: 600px;
      margin: auto;
      font-size: 18px;
    }
    h1 {
      text-align: center;
    }
    .info-box {
      background: #e0f0ff;
      border-left: 4px solid #0074D9;
      padding: 1rem;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .info-box span {
      font-size: 1.5rem;
    }
    input[type="number"], input[type="text"], input[type="range"] {
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    .section-title {
      font-weight: bold;
      font-size: 20px;
      margin-top: 2rem;
    }
    .range-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    .rate-input-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }
    .rate-input-row span {
      width: 20%;
      font-size: 0.95rem;
    }
    .rate-input-row input {
      width: 35%;
    }
    .inline-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1rem;
      padding: 1rem;
      width: 100%;
      font-size: 1.1rem;
      background-color: #005b96;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #result {
      background: #fff;
      padding: 1rem;
      margin-top: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      white-space: pre-line;
      font-size: 1rem;
    }
  </style>
</head>
<body onload="generateRateInputs()">
  <h1>🏠 住宅ローンシミュレーター2300</h1>

  <div class="info-box">
    <span>ℹ️</span>
    <p>
      借入額、返済期間、金利を入力して、毎月の返済額や利息、元本の推移をシミュレーションできます。<br>
      金利は半年ごとに個別設定でき、また一括入力も可能です。返済方式も切り替えられます。
    </p>
  </div>

  <div class="section-title">借入額（円）</div>
  <input type="text" id="amount" value="50,000,000" oninput="syncAmountFromText()" />
  <div class="range-labels">
    <span>1,000万円</span><span>1億円</span>
  </div>
  <input type="range" id="amount-range" min="10000000" max="100000000" step="100000" value="50000000" oninput="syncAmountFromRange()" />

  <div class="section-title">返済期間（年）</div>
  <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
  <div class="range-labels">
    <span>1年</span><span>50年</span>
  </div>
  <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

  <div class="section-title">返済方式</div>
  <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> 元利均等返済</label>
  <label><input type="radio" name="repaymentType" value="principalEqual" /> 元金均等返済</label>

  <div class="section-title">金利</div>

  <strong>全期間一括設定</strong><br>
  <div class="inline-group">
    <input type="number" id="bulk-rate" step="0.01" value="1.00" />
    <button type="button" onclick="applyBulkRate()">すべてに一括入力</button>
  </div>

  <strong>N年目以降に一括設定</strong><br>
  <div class="inline-group">
    <select id="from-year"></select>
    <input type="number" id="from-rate" step="0.01" />
    <button type="button" onclick="applyRateFromYear()">N年目以降に一括入力</button>
  </div>

  <div id="rate-inputs"></div>

  <button onclick="simulate()">シミュレーションする</button>
  <button onclick="downloadExcel()">📥 Excelダウンロード</button>

  <div id="result"></div>
  <canvas id="chart" width="400" height="200"></canvas>

  <script>
    let lastSimData = [];

    function syncAmountFromRange() {
      const val = parseInt(document.getElementById("amount-range").value);
      document.getElementById("amount").value = val.toLocaleString();
    }

    function syncAmountFromText() {
      const raw = document.getElementById("amount").value.replace(/[^\d]/g, '');
      const num = parseInt(raw || "0");
      document.getElementById("amount-range").value = num;
      document.getElementById("amount").value = num.toLocaleString();
    }

    function syncYearsFromRange() {
      const val = parseInt(document.getElementById("years-range").value);
      document.getElementById("years").value = val;
      generateRateInputs();
    }

    function syncYearsFromInput() {
      const val = parseInt(document.getElementById("years").value);
      document.getElementById("years-range").value = val;
      generateRateInputs();
    }

    function parseAmount(value) {
      return parseFloat(value.replace(/,/g, ""));
    }

    function generateRateInputs() {
      const container = document.getElementById("rate-inputs");
      container.innerHTML = "";
      const years = parseInt(document.getElementById("years").value);
      const fromYearSelect = document.getElementById("from-year");
      fromYearSelect.innerHTML = "";

      for (let y = 1; y <= years; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = `${y} 年目以降`;
        fromYearSelect.appendChild(option);

        const row = document.createElement("div");
        row.className = "rate-input-row";
        const label = document.createElement("span");
        label.textContent = `${y}年目`;

        const input1 = document.createElement("input");
        const input2 = document.createElement("input");

        [input1, input2].forEach((input, i) => {
          input.type = "number";
          input.step = "0.01";
          input.value = "1.00";
          input.className = "rate-input";
          input.dataset.index = (y - 1) * 2 + i;
        });

        row.appendChild(label);
        row.appendChild(input1);
        row.appendChild(input2);
        container.appendChild(row);
      }
    }

    function applyBulkRate() {
      const rate = parseFloat(document.getElementById("bulk-rate").value);
      if (isNaN(rate)) return alert("有効な金利を入力してください。");
      document.querySelectorAll(".rate-input").forEach(input => input.value = rate.toFixed(2));
    }

    function applyRateFromYear() {
      const fromYear = parseInt(document.getElementById("from-year").value);
      const rate = parseFloat(document.getElementById("from-rate").value);
      if (isNaN(rate)) return alert("有効な金利を入力してください。");
      const inputs = document.querySelectorAll(".rate-input");
      const startIndex = (fromYear - 1) * 2;
      for (let i = startIndex; i < inputs.length; i++) {
        inputs[i].value = rate.toFixed(2);
      }
    }

    function simulate() {
      const amount = parseAmount(document.getElementById("amount").value);
      const years = parseInt(document.getElementById("years").value);
      const months = years * 12;
      const repaymentType = document.querySelector("input[name='repaymentType']:checked").value;

      const rateInputs = Array.from(document.querySelectorAll(".rate-input"));
      const expectedRateCount = years * 2;
      if (rateInputs.length < expectedRateCount) {
        alert("金利の入力が不足しています。");
        return;
      }

      const halfYearRates = rateInputs.map(input => parseFloat(input.value));
      if (halfYearRates.some(r => isNaN(r))) {
        alert("すべての金利欄に有効な数字を入力してください。");
        return;
      }

      const monthlyRates = [];
      for (let i = 0; i < years; i++) {
        monthlyRates.push(...Array(6).fill(halfYearRates[i * 2]));
        monthlyRates.push(...Array(6).fill(halfYearRates[i * 2 + 1]));
      }

      let remaining = amount;
      let totalInterest = 0;
      let balanceData = [];
      let simData = [];
      let labels = [];
      const monthlyPrincipal = repaymentType === "principalEqual" ? amount / months : null;

      for (let i = 0; i < months; i++) {
        const rate = monthlyRates[i] / 100 / 12;
        const interest = remaining * rate;
        let principal, payment;

        if (repaymentType === "principalEqual") {
          principal = monthlyPrincipal;
          payment = principal + interest;
        } else {
          const n = months - i;
          payment = remaining * rate / (1 - Math.pow(1 + rate, -n));
          principal = payment - interest;
        }

        totalInterest += interest;
        remaining -= principal;
        balanceData.push(Math.max(remaining, 0));
        labels.push(`${Math.floor(i / 12) + 1}年${(i % 12) + 1}月`);
        simData.push({
          月: `${Math.floor(i / 12) + 1}年${(i % 12) + 1}月`,
          返済額: Math.round(payment),
          元金: Math.round(principal),
          利息: Math.round(interest),
          残高: Math.round(Math.max(remaining, 0))
        });
      }

      const firstPayment = simData[0].返済額;
      document.getElementById("result").textContent =
        `初回の毎月返済額: ${firstPayment.toLocaleString()} 円\n` +
        `総返済額: ${(amount + totalInterest).toLocaleString(undefined, { maximumFractionDigits: 0 })} 円\n` +
        `うち利息: ${(totalInterest).toLocaleString(undefined, { maximumFractionDigits: 0 })} 円`;

      lastSimData = simData;

      const ctx = document.getElementById("chart").getContext("2d");
      if (window.chartInstance) window.chartInstance.destroy();
      window.chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "元本残高の推移",
            data: balanceData,
            borderColor: "#0074D9",
            fill: false,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => value.toLocaleString()
              }
            }
          }
        }
      });
    }

    function downloadExcel() {
      if (!lastSimData.length) {
        alert("まずシミュレーションを実行してください。");
        return;
      }
      const worksheet = XLSX.utils.json_to_sheet(lastSimData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "返済シミュレーション");
      XLSX.writeFile(workbook, "loan_simulation.xlsx");
    }
  </script>
</body>
</html>
