<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆmagazine styleãƒ»ä¸‡å††è¡¨ç¤ºï¼‰</title>
Â  <!-- Fonts -->
Â  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
Â  <!-- Libs -->
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.0.0"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
Â  <style>
Â Â Â  :root{
Â Â Â Â Â  --navy:#0e2a47;
Â Â Â Â Â  --teal:#10939a;
Â Â Â Â Â  --teal-2:#0c7e86;
Â Â Â Â Â  --yellow:#ffbf3a;
Â Â Â Â Â  --yellow-2:#ffe28f;
Â Â Â Â Â  --bg:#f7fafc;
Â Â Â Â Â  --card:#ffffff;
Â Â Â Â Â  --muted:#5f6f84;
Â Â Â Â Â  --ring:rgba(16,147,154,.25);
Â Â Â Â Â  --line:#e6edf5;
Â Â Â Â Â  --coral:#ff4d6d;
Â Â Â Â Â  --coral-2:#ff6b81;
Â Â Â  }
Â Â Â  *{box-sizing:border-box}
Â Â Â  body{
Â Â Â Â Â  font-family: "Noto Sans JP", Noto Sans, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", sans-serif;
Â Â Â Â Â  padding:20px; background:var(--bg); max-width:1100px; margin:auto; font-size:18px; color:#102a43;
Â Â Â Â Â  background-image: radial-gradient(ellipse at 10% -20%, rgba(255,216,97,.18), transparent 45%),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  radial-gradient(ellipse at 110% 10%, rgba(25,183,181,.08), transparent 40%);
Â Â Â  }

Â Â Â  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¨ãƒªã‚¢ */
Â Â Â  .title-wrap{ text-align:center; margin:6px 0 10px;}
Â Â Â  /* â˜…ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ã‚¿ã‚¤ãƒˆãƒ«ã®ä¸Šã€‚èƒŒæ™¯ãƒ»æ ãªã—ï¼ˆèƒŒæ™¯ã«é¦´æŸ“ã‚€ï¼‰ */
Â Â Â  .subtitle{
Â Â Â Â Â  display:inline-block; margin-bottom:8px; font-weight:800; color:#0d3a57; letter-spacing:.08em;
Â Â Â  }
Â Â Â  .subtitle::before{ content:"ï¼¼ "; }
Â Â Â  .subtitle::after{ content:" ï¼"; }
Â Â Â  .title{ margin:0; color:var(--navy); font-weight:900; letter-spacing:.02em; font-size:clamp(22px,4.5vw,32px);}

Â Â Â  .card{
Â Â Â Â Â  background:var(--card); border-radius:16px; padding:18px; margin-top:16px;
Â Â Â Â Â  box-shadow: 0 8px 24px rgba(15,48,87,.08);
Â Â Â Â Â  border: 1px solid #eef3f9;
Â Â Â Â Â  position: relative;
Â Â Â  }
Â Â Â  /* â˜…ãƒ”ãƒ«è¦‹å‡ºã—ã¯ãƒ–ãƒ­ãƒƒã‚¯åŒ–ï¼ˆæ¬¡ã®è¦ç´ ã‚’å¿…ãšä¸‹æ®µã¸ï¼‰ */
Â Â Â  .panel-title{
Â Â Â Â Â  display:flex; align-items:center; gap:.5rem; margin:-6px 0 14px; font-weight:900; color:var(--navy);
Â Â Â Â Â  background:linear-gradient(90deg, var(--yellow), var(--yellow-2));
Â Â Â Â Â  padding:.45rem .9rem; border-radius:999px; border:1px solid rgba(0,0,0,.06);
Â Â Â Â Â  box-shadow: 0 4px 0 rgba(15,48,87,.08);
Â Â Â Â Â  font-size: 18px;
Â Â Â Â Â  width: fit-content;
Â Â Â  }
Â Â Â  .panel-title .chip{
Â Â Â Â Â  display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:999px;
Â Â Â Â Â  background:linear-gradient(135deg,var(--teal),var(--teal-2)); color:white; font-weight:900; font-size:.9rem;
Â Â Â Â Â  box-shadow:0 2px 0 rgba(0,0,0,.12);
Â Â Â  }

Â Â Â  /* æ–œç·šèƒŒæ™¯ã®å°è¦‹å‡ºã— */
Â Â Â  .section-title{
Â Â Â Â Â  font-weight:900; font-size:16px; color:var(--navy); margin:18px 0 8px; padding:.35rem .7rem;
Â Â Â Â Â  background: repeating-linear-gradient(-45deg, rgba(255,216,97,.35) 0 6px, rgba(255,216,97,.22) 6px 12px);
Â Â Â Â Â  border-radius:8px;
Â Â Â Â Â  display:block;Â Â  /* â˜…å¿…ãšæ”¹è¡Œã•ã›ã‚‹ */
Â Â Â Â Â  width: fit-content;
Â Â Â  }

Â Â Â  .range-labels{ display:flex; justify-content:space-between; font-size:.9rem; color:var(--muted); margin:4px 0 8px;}
Â Â Â  .inline-group{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px;}

Â Â Â  input[type="number"], input[type="text"], input[type="range"], select{
Â Â Â Â Â  padding:.7rem .8rem; font-size:1rem; width:100%; border-radius:12px; border:1px solid #dfe8f2; background:#fff;
Â Â Â Â Â  transition: box-shadow .15s ease, border-color .15s ease;
Â Â Â  }
Â Â Â  input[type="number"]:focus, input[type="text"]:focus, select:focus{
Â Â Â Â Â  outline:none; border-color: var(--teal-2); box-shadow: 0 0 0 4px var(--ring);
Â Â Â  }
Â Â Â  input[type="range"]{ accent-color: var(--teal-2); }

Â Â Â  /* Buttonsï¼ˆãƒ•ã‚©ãƒ³ãƒˆï¼‹2ptï¼‰ */
Â Â Â  .actions{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-top:12px;}
Â Â Â  .btn{
Â Â Â Â Â  appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.02em;
Â Â Â Â Â  padding:1rem; border-radius:12px; transition: transform .06s ease, box-shadow .2s ease, filter .2s ease;
Â Â Â Â Â  font-size: calc(1rem + 2pt);
Â Â Â  }
Â Â Â  .btn:active{ transform: translateY(1px); }
Â Â Â  /* ç›®ç«‹ã¤ã‚³ãƒ¼ãƒ©ãƒ«è‰² */
Â Â Â  .btn-primary{
Â Â Â Â Â  color:#fff; background: linear-gradient(135deg, var(--coral), var(--coral-2));
Â Â Â Â Â  border:1px solid rgba(0,0,0,.12); box-shadow: 0 10px 22px rgba(255,77,109,.35);
Â Â Â  }
Â Â Â  .btn-primary:hover{ filter:brightness(1.05); }
Â Â Â  .btn-ghost{
Â Â Â Â Â  background: linear-gradient(135deg,#bfe8ea,#8fdde0);
Â Â Â Â Â  color:#083b40; border:1px solid #6fd0d3; box-shadow: 0 4px 10px rgba(13,126,134,.18);
Â Â Â  }

Â Â Â  .kpi{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:12px;}
Â Â Â  .kpi .tile{ background:#fff; border:1px dashed #d9e6f3; border-radius:12px; padding:14px;}
Â Â Â  .kpi .label{ font-size:.9rem; color:#3a5066;}
Â Â Â  .kpi .value{ font-weight:900; font-size:1.3rem; margin-top:4px; color:var(--navy);}
Â Â Â  #result{ white-space: pre-line; font-size:1rem; background:#fffef5; border:1px dashed #ffe28d; border-radius:10px; padding:10px;}

Â Â Â  table{ width:100%; border-collapse: collapse; margin-top: 18px; font-size: 0.95rem;}
Â Â Â  th, td{ border:1px solid var(--line); padding:.6rem; text-align:right;}
Â Â Â  th{ background:#f2fbfc; color:#0b4a4f; font-weight:800;}

Â Â Â  /* ã‚°ãƒ©ãƒ•ãƒ©ãƒƒãƒ‘ãƒ¼ */
Â Â Â  .chart-block{ margin-top:14px; }
Â Â Â  .chart-title{ font-size: 16px; font-weight:800; color:var(--navy); margin: 6px 4px; }
Â Â Â  .chart-wrap{
Â Â Â Â Â  width:100%; height:240px; background:
Â Â Â Â Â Â Â  linear-gradient(#ffffff,#ffffff) padding-box,
Â Â Â Â Â Â Â  repeating-linear-gradient(0deg, #f2f7fb 0 28px, #e9f1f8 28px 29px) border-box;
Â Â Â Â Â  border:1px solid #dfe8f2; border-radius:12px; padding:10px; overflow:hidden;
Â Â Â  }
Â Â Â  .chart-wrap > canvas{ display:block; width:100% !important; height:100% !important; }
Â Â Â  @media (max-width: 640px){ .chart-wrap{ height:120px; } }

Â Â Â  .rate-input-row{ display:flex; align-items:center; gap:10px; margin-top:8px;}
Â Â Â  .rate-input-row span{ width:20%; font-size:.95rem; color:var(--muted);}
Â Â Â  .rate-input-row input{ width:35%; }
Â Â Â  .note{ font-size:.9rem; color:#3a5066; margin-top:4px}
Â Â Â  .row-end{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px;}
Â Â Â  .hint{ font-size:.9rem; color:#3a5066;}
Â  </style>
</head>
<body onload="generateRateInputs()">
Â  <div class="title-wrap">
Â Â Â  <div class="subtitle">é‡‘åˆ©ã®å¤‰å‹•ã«å¯¾å¿œ</div>
Â Â Â  <h1 class="title">ä½å®…ãƒ­ãƒ¼ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
Â  </div>

Â  <!-- æ¡ä»¶ -->
Â  <div class="card">
Â Â Â  <div class="panel-title"><span class="chip">1</span>æ¡ä»¶</div>

Â Â Â  <!-- â˜…ã€Œå€Ÿå…¥é¡ï¼ˆä¸‡å††ï¼‰ã€ã¯ãƒ‘ãƒãƒ«è¦‹å‡ºã—ã®â€œä¸‹â€ -->
Â Â Â  <div class="section-title">å€Ÿå…¥é¡ï¼ˆä¸‡å††ï¼‰</div>
Â Â Â  <input type="text" id="amount" value="5000" oninput="syncAmountFromText()" />
Â Â Â  <!-- ç›®ç››ã‚Šè¡¨ç¤ºã‚’ 1,000ä¸‡å†† / 2å„„å†† -->
Â Â Â  <div class="range-labels"><span>1,000ä¸‡å††</span><span>2å„„å††</span></div>
Â Â Â  <input type="range" id="amount-range" min="1000" max="10000" step="10" value="5000" oninput="syncAmountFromRange()" />

Â Â Â  <div class="section-title">è¿”æ¸ˆæœŸé–“ï¼ˆå¹´ï¼‰</div>
Â Â Â  <input type="number" id="years" value="35" oninput="syncYearsFromInput()" />
Â Â Â  <!-- ç›®ç››ã‚Šè¡¨ç¤ºã‚’ 1å¹´ / 50å¹´ -->
Â Â Â  <div class="range-labels"><span>1å¹´</span><span>50å¹´</span></div>
Â Â Â  <input type="range" id="years-range" min="1" max="50" step="1" value="35" oninput="syncYearsFromRange()" />

Â Â Â  <div class="section-title">è¿”æ¸ˆæ–¹å¼</div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <label><input type="radio" name="repaymentType" value="principalAndInterestEqual" checked /> å…ƒåˆ©å‡ç­‰è¿”æ¸ˆ</label>
Â Â Â Â Â  <label><input type="radio" name="repaymentType" value="principalEqual" /> å…ƒé‡‘å‡ç­‰è¿”æ¸ˆ</label>
Â Â Â  </div>

Â Â Â  <!-- è¦‹å‡ºã—åï¼šé‡‘åˆ©ï¼ˆï¼…ï¼‰ -->
Â Â Â  <div class="section-title">é‡‘åˆ©ï¼ˆï¼…ï¼‰</div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <input type="number" id="bulk-rate" step="0.01" value="1.00" />
Â Â Â Â Â  <button type="button" class="btn btn-ghost" onclick="applyBulkRate()">ã™ã¹ã¦ã«ä¸€æ‹¬å…¥åŠ›</button>
Â Â Â  </div>
Â Â Â  <div class="inline-group">
Â Â Â Â Â  <select id="from-year"></select>
Â Â Â Â Â  <input type="number" id="from-rate" step="0.01" />
Â Â Â Â Â  <button type="button" class="btn btn-ghost" onclick="applyRateFromYear()">Nå¹´ç›®ä»¥é™ã«ä¸€æ‹¬å…¥åŠ›</button>
Â Â Â  </div>

Â Â Â  <div id="rate-inputs"></div>

Â Â Â  <div class="section-title">ğŸ“ˆ ãƒ‰ãƒ©ãƒƒã‚°ã§é‡‘åˆ©ç·¨é›†ï¼ˆåŠå¹´ã”ã¨ï¼‰</div>
Â Â Â  <p class="note">ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ã¨ã€Œãã®ç‚¹ä»¥é™ã¯åŒã˜é‡‘åˆ©ã€ã€Œãã‚Œä»¥å‰ã¯ç›´å‰3ãƒã‚¤ãƒ³ãƒˆï¼ˆ=1.5å¹´ï¼‰ã ã‘ãªã ã‚‰ã‹ã«è¿‘ã¥ãã€</p>
Â Â Â  <div class="chart-wrap"><canvas id="rateChart"></canvas></div>

Â Â Â  <div class="actions">
Â Â Â Â Â  <!-- â˜…ã‚³ãƒ¼ãƒ©ãƒ«ã§ç›®ç«‹ãŸã›ã‚‹ -->
Â Â Â Â Â  <button class="btn btn-primary" onclick="simulate()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹</button>
Â Â Â  </div>
Â  </div>

Â  <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ -->
Â  <div class="card">
Â Â Â  <div class="panel-title"><span class="chip">2</span>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ</div>
Â Â Â  <div id="result"></div>

Â Â Â  <div class="kpi" id="kpiTiles" style="display:none;">
Â Â Â Â Â  <div class="tile"><div class="label">åˆæœˆã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-first"></div></div>
Â Â Â Â Â  <div class="tile"><div class="label">å¹³å‡ã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-avg"></div></div>
Â Â Â Â Â  <div class="tile"><div class="label">æœ€å¤§ã®æœˆã€…è¿”æ¸ˆé¡</div><div class="value" id="kpi-max"></div></div>
Â Â Â  </div>

Â Â Â  <div class="chart-block">
Â Â Â Â Â  <div class="chart-title">æœˆã€…ã®æ”¯æ‰•é¡</div>
Â Â Â Â Â  <div class="chart-wrap"><canvas id="paymentChart"></canvas></div>
Â Â Â  </div>
Â Â Â  <div class="chart-block">
Â Â Â Â Â  <div class="chart-title">æ”¯æ‰•å†…è¨³ï¼ˆå…ƒé‡‘/åˆ©æ¯ï¼‰</div>
Â Â Â Â Â  <div class="chart-wrap"><canvas id="stackedChart"></canvas></div>
Â Â Â  </div>

Â Â Â  <div class="row-end">
Â Â Â Â Â  <label class="hint"><input type="checkbox" id="toggle-table" checked> æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º</label>
Â Â Â Â Â  <span class="hint">â€»ã‚ªãƒ•ã«ã™ã‚‹ã¨è»½ããªã‚Šã¾ã™</span>
Â Â Â  </div>
Â Â Â  <div id="repayment-table"></div>

Â Â Â  <div class="actions">
Â Â Â Â Â  <button class="btn btn-ghost" onclick="downloadExcel()">ğŸ“¥ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã‚’Excelã§ä¿å­˜</button>
Â Â Â  </div>
Â  </div>

Â  <script>
Â  // ========= ã‚°ãƒ­ãƒ¼ãƒãƒ« =========
Â  let lastSimData = [];
Â  let rateChartInstance = null;
Â  let paymentChart = null, stackedChart = null;

Â  // ========= å…¥å‡ºåŠ›åŒæœŸï¼ˆä¸‡å††ï¼‰ =========
Â  function syncAmountFromRange() {
Â Â Â  const val = parseInt(document.getElementById('amount-range').value);
Â Â Â  document.getElementById('amount').value = val.toLocaleString();
Â  }
Â  function syncAmountFromText() {
Â Â Â  const raw = document.getElementById('amount').value.replace(/[^\d]/g, '');
Â Â Â  const num = parseInt(raw || '0');
Â Â Â  document.getElementById('amount-range').value = num;
Â Â Â  document.getElementById('amount').value = num.toLocaleString();
Â  }
Â  function syncYearsFromRange() {
Â Â Â  const val = parseInt(document.getElementById('years-range').value);
Â Â Â  document.getElementById('years').value = val;
Â Â Â  generateRateInputs();
Â  }
Â  function syncYearsFromInput() {
Â Â Â  const val = parseInt(document.getElementById('years').value);
Â Â Â  document.getElementById('years-range').value = val;
Â Â Â  generateRateInputs();
Â  }
Â  function parseAmount(v) { return parseFloat(v.replace(/,/g, '')) * 10000; } // ä¸‡å†† â†’ å††

Â  // ========= é‡‘åˆ©å…¥åŠ›ç”Ÿæˆ =========
Â  function generateRateInputs() {
Â Â Â  const container = document.getElementById('rate-inputs');
Â Â Â  container.innerHTML = '';
Â Â Â  const years = parseInt(document.getElementById('years').value);
Â Â Â  const fromYearSelect = document.getElementById('from-year');
Â Â Â  fromYearSelect.innerHTML = '';

Â Â Â  for (let y = 1; y <= years; y++) {
Â Â Â Â Â  const option = document.createElement('option');
Â Â Â Â Â  option.value = y; option.textContent = `${y} å¹´ç›®ä»¥é™`; fromYearSelect.appendChild(option);

Â Â Â Â Â  const row = document.createElement('div'); row.className = 'rate-input-row';
Â Â Â Â Â  const label = document.createElement('span'); label.textContent = `${y}å¹´ç›®`;
Â Â Â Â Â  const input1 = document.createElement('input'); const input2 = document.createElement('input');
Â Â Â Â Â  [input1, input2].forEach((input, i) => {
Â Â Â Â Â Â Â  input.type = 'number'; input.step = '0.01'; input.value = '1.00'; input.className = 'rate-input';
Â Â Â Â Â Â Â  input.dataset.index = (y - 1) * 2 + i; input.addEventListener('input', updateRateChartFromInputs);
Â Â Â Â Â  });
Â Â Â Â Â  row.appendChild(label); row.appendChild(input1); row.appendChild(input2); container.appendChild(row);
Â Â Â  }
Â Â Â  drawRateChart();
Â  }

Â  // ========= å…¥åŠ› â†’ ã‚°ãƒ©ãƒ•åæ˜  =========
Â  function updateRateChartFromInputs() {
Â Â Â  const inputs = Array.from(document.querySelectorAll('.rate-input'));
Â Â Â  const rates = inputs.map(el => parseFloat(el.value) || 0);
Â Â Â  if (rateChartInstance) {
Â Â Â Â Â  rateChartInstance.data.labels = rates.map((_, i) => `${Math.floor(i / 2) + 1}å¹´ç›®`);
Â Â Â Â Â  rateChartInstance.data.datasets[0].data = rates;
Â Â Â Â Â  rateChartInstance.update();
Â Â Â  }
Â  }

Â  // ========= ã‚°ãƒ©ãƒ• â†’ å…¥åŠ›åæ˜  =========
Â  function updateInputsFromRateChart(rates) {
Â Â Â  const inputs = document.querySelectorAll('.rate-input');
Â Â Â  rates.forEach((r, i) => { inputs[i].value = parseFloat(r).toFixed(2); });
Â Â Â  simulate(); // ã‚°ãƒ©ãƒ•å¤‰æ›´æ™‚ã¯å³å†è¨ˆç®—
Â  }

Â  // ========= é‡‘åˆ©ä¸€æ‹¬é©ç”¨ =========
Â  function applyBulkRate() {
Â Â Â  const rate = parseFloat(document.getElementById('bulk-rate').value);
Â Â Â  if (isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
Â Â Â  document.querySelectorAll('.rate-input').forEach(inp => inp.value = rate.toFixed(2));
Â Â Â  updateRateChartFromInputs();
Â  }
Â  function applyRateFromYear() {
Â Â Â  const fromYear = parseInt(document.getElementById('from-year').value);
Â Â Â  const rate = parseFloat(document.getElementById('from-rate').value);
Â Â Â  if (isNaN(rate)) return alert('æœ‰åŠ¹ãªé‡‘åˆ©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
Â Â Â  const inputs = document.querySelectorAll('.rate-input');
Â Â Â  const startIndex = (fromYear - 1) * 2;
Â Â Â  for (let i = startIndex; i < inputs.length; i++) inputs[i].value = rate.toFixed(2);
Â Â Â  updateRateChartFromInputs();
Â  }

Â  // ========= ãƒ‰ãƒ©ãƒƒã‚°å¯¾å¿œã‚°ãƒ©ãƒ•ï¼ˆXè»¸=1å¹´ç½®ãï¼Yæœ€å¤§8%ï¼‰ =========
Â  function drawRateChart() {
Â Â Â  const inputs = Array.from(document.querySelectorAll('.rate-input'));
Â Â Â  const rates = inputs.map(el => parseFloat(el.value) || 0);

Â Â Â  const ctx = document.getElementById('rateChart').getContext('2d');
Â Â Â  if (rateChartInstance) rateChartInstance.destroy();

Â Â Â  rateChartInstance = new Chart(ctx, {
Â Â Â Â Â  type: 'line',
Â Â Â Â Â  data: {
Â Â Â Â Â Â Â  labels: rates.map((_, i) => `${Math.floor(i / 2) + 1}å¹´ç›®`),
Â Â Â Â Â Â Â  datasets: [{
Â Â Â Â Â Â Â Â Â  label: 'åŠå¹´ã”ã¨ã®é‡‘åˆ©ï¼ˆï¼…ï¼‰',
Â Â Â Â Â Â Â Â Â  data: rates,
Â Â Â Â Â Â Â Â Â  borderColor: '#0c7e86',
Â Â Â Â Â Â Â Â Â  backgroundColor: 'rgba(12,126,134,0.12)',
Â Â Â Â Â Â Â Â Â  pointRadius: 4,
Â Â Â Â Â Â Â Â Â  pointHoverRadius: 7,
Â Â Â Â Â Â Â Â Â  pointHitRadius: 14,
Â Â Â Â Â Â Â Â Â  borderWidth: 3,
Â Â Â Â Â Â Â Â Â  tension: 0.2
Â Â Â Â Â Â Â  }]
Â Â Â Â Â  },
Â Â Â Â Â  options: {
Â Â Â Â Â Â Â  responsive: true,
Â Â Â Â Â Â Â  maintainAspectRatio: false,
Â Â Â Â Â Â Â  animation: false,
Â Â Â Â Â Â Â  scales: {
Â Â Â Â Â Â Â Â Â  x: {
Â Â Â Â Â Â Â Â Â Â Â  grid: { display: false },
Â Â Â Â Â Â Â Â Â Â Â  title: { display: true, text: 'ä½•å¹´ç›®', color:'#0e2a47', font:{weight:'bold'} },
Â Â Â Â Â Â Â Â Â Â Â  ticks: {
Â Â Â Â Â Â Â Â Â Â Â Â Â  autoSkip: false,
Â Â Â Â Â Â Â Â Â Â Â Â Â  maxRotation: 0,
Â Â Â Â Â Â Â Â Â Â Â Â Â  font: { size: 14 },
Â Â Â Â Â Â Â Â Â Â Â Â Â  callback: (value, index) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // 1å¹´ã”ã¨ï¼ˆ2ç‚¹ã”ã¨ï¼‰ã«ã€Œ1,2,3â€¦ã€ã‚’è¡¨ç¤º
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (index % 2 === 1) return Math.floor(index / 2) + 1;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return '';
Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â  y: {
Â Â Â Â Â Â Â Â Â Â Â  beginAtZero: true,
Â Â Â Â Â Â Â Â Â Â Â  min: 0,
Â Â Â Â Â Â Â Â Â Â Â  max: 8,
Â Â Â Â Â Â Â Â Â Â Â  grid: { color: 'rgba(0,0,0,0.08)' },
Â Â Â Â Â Â Â Â Â Â Â  ticks: { font: { size: 14 }, callback: v => Number(v).toFixed(1) + '%' }
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  plugins: {
Â Â Â Â Â Â Â Â Â  legend: { display: false },
Â Â Â Â Â Â Â Â Â  tooltip: {
Â Â Â Â Â Â Â Â Â Â Â  backgroundColor:'#0e2a47', titleColor:'#fff', bodyColor:'#fff',
Â Â Â Â Â Â Â Â Â Â Â  callbacks: {
Â Â Â Â Â Â Â Â Â Â Â Â Â  title: (items)=> {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const i = items[0].dataIndex;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  return `${Math.floor(i/2)+1}å¹´ç›®ï¼ˆ${i%2===0?'å‰åŠ':'å¾ŒåŠ'}ï¼‰`;
Â Â Â Â Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â Â Â Â Â  label: ctx => `é‡‘åˆ©: ${Number(ctx.parsed.y).toFixed(2)}%`
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â Â Â  dragData: {
Â Â Â Â Â Â Â Â Â Â Â  round: 2,
Â Â Â Â Â Â Â Â Â Â Â  showTooltip: true,
Â Â Â Â Â Â Â Â Â Â Â  onDragEnd: function (e, datasetIndex, index, value) {
Â Â Â Â Â Â Â Â Â Â Â Â Â  // 0ã€œ8%ã«ã‚¯ãƒ©ãƒ³ãƒ—
Â Â Â Â Â Â Â Â Â Â Â Â Â  value = Math.max(0, Math.min(8, value));
Â Â Â Â Â Â Â Â Â Â Â Â Â  const oldData = rateChartInstance.data.datasets[0].data;
Â Â Â Â Â Â Â Â Â Â Â Â Â  const newRates = [...oldData];
Â Â Â Â Â Â Â Â Â Â Â Â Â  const len = newRates.length;
Â Â Â Â Â Â Â Â Â Â Â Â Â  const SMOOTH_PRE_RANGE = 3; // ç›´å‰3ãƒã‚¤ãƒ³ãƒˆ

Â Â Â Â Â Â Â Â Â Â Â Â Â  // ä»¥é™ã¯åŒã˜å€¤
Â Â Â Â Â Â Â Â Â Â Â Â Â  for (let i = index; i < len; i++) newRates[i] = value;
Â Â Â Â Â Â Â Â Â Â Â Â Â  // ç›´å‰ã ã‘ãªã ã‚‰ã‹ã«
Â Â Â Â Â Â Â Â Â Â Â Â Â  const start = Math.max(0, index - SMOOTH_PRE_RANGE);
Â Â Â Â Â Â Â Â Â Â Â Â Â  const span = index - start;
Â Â Â Â Â Â Â Â Â Â Â Â Â  if (span > 0) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  for (let i = start; i < index; i++) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const t = (i - start + 1) / span;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  newRates[i] = oldData[i] * (1 - t) + value * t;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â Â Â  updateInputsFromRateChart(newRates);
Â Â Â Â Â Â Â Â Â Â Â Â Â  rateChartInstance.data.datasets[0].data = newRates;
Â Â Â Â Â Â Â Â Â Â Â Â Â  rateChartInstance.update();
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  }
Â Â Â Â Â  },
Â Â Â Â Â  plugins: [Chart.registry.getPlugin('dragdata')]
Â Â Â  });
Â  }

Â  // ========= ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ«ãƒ¼ãƒ«ãªã—ï¼‰ =========
Â  function simulate() {
Â Â Â  const amount = parseAmount(document.getElementById('amount').value); // å††
Â Â Â  const years = parseInt(document.getElementById('years').value);
Â Â Â  const months = years * 12;
Â Â Â  const repaymentType = document.querySelector("input[name='repaymentType']:checked").value;
Â Â Â  const rates = Array.from(document.querySelectorAll('.rate-input')).map(el => parseFloat(el.value) / 100);

Â Â Â  if (!amount || !years) { alert('å€Ÿå…¥é¡ã¨è¿”æ¸ˆæœŸé–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
Â Â Â  if (rates.length < Math.ceil(months / 6)) { alert('é‡‘åˆ©ã®å…¥åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'); return; }

Â Â Â  let balance = amount;
Â Â Â  const result = [];
Â Â Â  const payments = [];
Â Â Â  let totalPrincipal = 0, totalInterest = 0;

Â Â Â  for (let m = 0; m < months; m++) {
Â Â Â Â Â  const rateIdx = Math.floor(m / 6);
Â Â Â Â Â  const annualRate = rates[rateIdx] || 0;
Â Â Â Â Â  const r = annualRate / 12;
Â Â Â Â Â  const remain = months - m;

Â Â Â Â Â  let interest = balance * r;
Â Â Â Â Â  let principal, paymentOut;

Â Â Â Â Â  if (repaymentType === 'principalAndInterestEqual') {
Â Â Â Â Â Â Â  paymentOut = r > 0
Â Â Â Â Â Â Â Â Â  ? balance * r * Math.pow(1 + r, remain) / (Math.pow(1 + r, remain) - 1)
Â Â Â Â Â Â Â Â Â  : balance / remain;
Â Â Â Â Â Â Â  interest = balance * r;
Â Â Â Â Â Â Â  principal = paymentOut - interest;
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  principal = amount / months;
Â Â Â Â Â Â Â  interest = balance * r;
Â Â Â Â Â Â Â  paymentOut = principal + interest;
Â Â Â Â Â  }

Â Â Â Â Â  balance -= principal;
Â Â Â Â Â  if (balance < 0) balance = 0;
Â Â Â Â Â  totalPrincipal += principal;
Â Â Â Â Â  totalInterest += interest;
Â Â Â Â Â  payments.push(paymentOut);

Â Â Â Â Â  result.push({
Â Â Â Â Â Â Â  æœˆ: m + 1,
Â Â Â Â Â Â Â  å…ƒé‡‘: Math.round(principal),
Â Â Â Â Â Â Â  åˆ©æ¯: Math.round(interest),
Â Â Â Â Â Â Â  æ®‹é«˜: Math.round(balance),
Â Â Â Â Â Â Â  æ”¯æ‰•é¡: Math.round(paymentOut)
Â Â Â Â Â  });
Â Â Â  }

Â Â Â  lastSimData = result;
Â Â Â  displayResult(result, totalPrincipal, totalInterest, payments);
Â Â Â  drawCharts(result);
Â  }

Â  // ========= çµæœè¡¨ç¤º =========
Â  function displayResult(data, totalPrincipal, totalInterest, payments) {
Â Â Â  const totalRepayment = Math.ceil(totalPrincipal + totalInterest);
Â Â Â  const interestRounded = Math.ceil(totalInterest);
Â Â Â  const firstPay = Math.round(payments[0] || 0);
Â Â Â  const avgPay = Math.round(payments.reduce((a,b)=>a+b,0) / payments.length || 0);
Â Â Â  const maxPay = Math.round(Math.max(...payments, 0));

Â Â Â  const div = document.getElementById('result');
Â Â Â  div.innerHTML = `ğŸ ç·è¿”æ¸ˆé¡: ${totalRepayment.toLocaleString()} å††\nğŸ“Š ç·åˆ©æ¯: ${interestRounded.toLocaleString()} å††`;

Â Â Â  document.getElementById('kpiTiles').style.display = 'grid';
Â Â Â  document.getElementById('kpi-first').textContent = `${firstPay.toLocaleString()} å††`;
Â Â Â  document.getElementById('kpi-avg').textContentÂ Â  = `${avgPay.toLocaleString()} å††`;
Â Â Â  document.getElementById('kpi-max').textContentÂ Â  = `${maxPay.toLocaleString()} å††`;

Â Â Â  const showTable = document.getElementById('toggle-table').checked;
Â Â Â  const tableWrap = document.getElementById('repayment-table');
Â Â Â  tableWrap.innerHTML = '';
Â Â Â  if (showTable) {
Â Â Â Â Â  const table = document.createElement('table');
Â Â Â Â Â  const thead = table.createTHead();
Â Â Â Â Â  const tbody = table.createTBody();
Â Â Â Â Â  thead.innerHTML = '<tr><th>æœˆ</th><th>å…ƒé‡‘</th><th>åˆ©æ¯</th><th>æ”¯æ‰•é¡</th><th>æ®‹é«˜</th></tr>';
Â Â Â Â Â  for (let i=0;i<data.length;i++){
Â Â Â Â Â Â Â  const row = data[i];
Â Â Â Â Â Â Â  const tr = tbody.insertRow();
Â Â Â Â Â Â Â  const cols = ['æœˆ','å…ƒé‡‘','åˆ©æ¯','æ”¯æ‰•é¡','æ®‹é«˜'];
Â Â Â Â Â Â Â  for (let c=0;c<cols.length;c++){
Â Â Â Â Â Â Â Â Â  const td = tr.insertCell();
Â Â Â Â Â Â Â Â Â  td.textContent = row[cols[c]].toLocaleString();
Â Â Â Â Â Â Â  }
Â Â Â Â Â  }
Â Â Â Â Â  tableWrap.appendChild(table);
Â Â Â  }
Â  }

Â  // ========= ã‚°ãƒ©ãƒ•æç”»ï¼ˆYæœ€å°å€¤0ï¼‰ =========
Â  function drawCharts(data) {
Â Â Â  const labels = data.map(d => d['æœˆ']);
Â Â Â  const principalData = data.map(d => d['å…ƒé‡‘']);
Â Â Â  const interestData = data.map(d => d['åˆ©æ¯']);
Â Â Â  const paymentData = data.map(d => d['æ”¯æ‰•é¡']);

Â Â Â  if (paymentChart) paymentChart.destroy();
Â Â Â  if (stackedChart) stackedChart.destroy();

Â Â Â  const axisFont = { size: 14 };
Â Â Â  const common = {
Â Â Â Â Â  responsive:true,
Â Â Â Â Â  maintainAspectRatio:false,
Â Â Â Â Â  animation:false,
Â Â Â Â Â  scales: {
Â Â Â Â Â Â Â  x: { ticks: { maxRotation:0, autoSkip:true, autoSkipPadding:16, font:axisFont }, grid:{display:false} },
Â Â Â Â Â Â Â  y: { ticks: { font:axisFont }, grid:{ color:'rgba(0,0,0,0.08)' }, beginAtZero:true, min:0 }
Â Â Â Â Â  },
Â Â Â Â Â  plugins: { legend:{display:false} }
Â Â Â  };

Â Â Â  paymentChart = new Chart(document.getElementById('paymentChart').getContext('2d'), {
Â Â Â Â Â  type: 'bar',
Â Â Â Â Â  data: { labels, datasets: [{ label: 'æœˆã€…ã®æ”¯æ‰•é¡', data: paymentData, backgroundColor: '#0c7e86' }] },
Â Â Â Â Â  options: common
Â Â Â  });
Â Â Â  stackedChart = new Chart(document.getElementById('stackedChart').getContext('2d'), {
Â Â Â Â Â  type: 'bar',
Â Â Â Â Â  data: { labels, datasets: [
Â Â Â Â Â Â Â  { label: 'å…ƒé‡‘', data: principalData, backgroundColor: '#0c7e86' },
Â Â Â Â Â Â Â  { label: 'åˆ©æ¯', data: interestData, backgroundColor: '#ffbf3a' }
Â Â Â Â Â  ] },
Â Â Â Â Â  options: { ...common, scales: { ...common.scales, x:{...common.scales.x, stacked:true}, y:{...common.scales.y, stacked:true} } }
Â Â Â  });
Â  }

Â  // ========= Excelå‡ºåŠ› =========
Â  function downloadExcel() {
Â Â Â  if (!lastSimData.length) { alert('ã¾ãšã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return; }
Â Â Â  const ws = XLSX.utils.json_to_sheet(lastSimData);
Â Â Â  const wb = XLSX.utils.book_new();
Â Â Â  XLSX.utils.book_append_sheet(wb, ws, 'è¿”æ¸ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³');
Â Â Â  XLSX.writeFile(wb, 'loan_simulation.xlsx');
Â  }

Â  // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºãƒˆã‚°ãƒ«æ™‚ã¯å†æç”»ã®ã¿
Â  document.addEventListener('change', (e)=>{
Â Â Â  if (e.target && e.target.id === 'toggle-table' && lastSimData.length){
Â Â Â Â Â  let totalPrincipal=0,totalInterest=0;
Â Â Â Â Â  for(const r of lastSimData){ totalPrincipal+=r['å…ƒé‡‘']; totalInterest+=r['åˆ©æ¯']; }
Â Â Â Â Â  const payments = lastSimData.map(r=>r['æ”¯æ‰•é¡']);
Â Â Â Â Â  displayResult(lastSimData, totalPrincipal, totalInterest, payments);
Â Â Â  }
Â  });
Â  </script>
</body>
</html>
